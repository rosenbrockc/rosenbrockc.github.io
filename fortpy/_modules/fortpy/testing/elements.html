<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fortpy.testing.elements &mdash; fortpy 1.7.5 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.7.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="fortpy 1.7.5 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fortpy.testing.elements</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">msg</span>
<span class="kn">from</span> <span class="nn">fortpy.testing.templates</span> <span class="kn">import</span> <span class="n">FileLine</span>
<span class="kn">from</span> <span class="nn">fortpy.docelements</span> <span class="kn">import</span> <span class="n">DocElement</span><span class="p">,</span> <span class="n">DocGroup</span>
<span class="kn">from</span> <span class="nn">fortpy.printing.formatting</span> <span class="kn">import</span> <span class="n">present_params</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">remove</span>
<span class="kn">from</span> <span class="nn">fortpy.utility</span> <span class="kn">import</span> <span class="n">copyfile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">_expand_cases</span><span class="p">(</span><span class="n">casestr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list of case identifiers from the shorthand string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For specifying the cases in a unit test, we should allow ranges like</span>
    <span class="c1"># &quot;standard.cr[1-12]&quot; so that the developer doesn&#39;t need to enter each</span>
    <span class="c1"># of the cases separately. We should still allow a comma-separated list</span>
    <span class="c1"># of cases, but each must allow the shorthand notation.</span>
    <span class="n">rawcases</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="n">casestr</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">casestr</span><span class="p">:</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rxcase</span> <span class="o">=</span> <span class="s2">r&quot;(?P&lt;prefix&gt;[^[]*)\[(?P&lt;range&gt;\d+-\d+)](?P&lt;suffix&gt;.*)&quot;</span>
        <span class="n">recase</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">rxcase</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">craw</span> <span class="ow">in</span> <span class="n">rawcases</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">recase</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">craw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)))</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;suffix&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">craw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cases</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rawcases</span>

<div class="viewcode-block" id="TestSource"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSource">[docs]</a><span class="k">class</span> <span class="nc">TestSource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a link between the output of one unit test that is being used</span>
<span class="sd">    as input for another unit test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compkey</span><span class="p">,</span> <span class="n">testspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct the test source.</span>
<span class="sd">        </span>
<span class="sd">        :arg compkey: module.executable.parameter:testid:cases.</span>
<span class="sd">        :arg testspec: the instance of TestSpecification for the &lt;value&gt; or &lt;input&gt;</span>
<span class="sd">          tag using the &#39;testsource&quot; attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subkeys</span> <span class="o">=</span> <span class="n">compkey</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">subkeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The &#39;module.executable.parameter&#39; directive.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subkeys</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">subkeys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;The identifier of the test whose output will be used.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The list of test cases to use inputs for. One test case will be created</span>
<span class="sd">        for each distinct test source case using either &#39;one-to-one&#39; or &#39;cartesian&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subkeys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="n">subkeys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="n">_expand_cases</span><span class="p">(</span><span class="n">subkeys</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span> <span class="o">=</span> <span class="n">testspec</span>
        <span class="sd">&quot;&quot;&quot;The TestSpecification instance of the target whose input is being defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_parameter</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;The CodeElement instance of the parameter whose output is being used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_testoutput</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The TestTarget instance for the variable whose output is being used as</span>
<span class="sd">        the test source.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">varname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the local file *variable* that will contain</span>
<span class="sd">        the full path to the data to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;fpy_{}_ts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filevar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the code to reference a trimmed, clean version of the contents</span>
<span class="sd">        of the variable containing the full path to the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;trim(adjustl({}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the local file that will contain</span>
<span class="sd">        the full path to the data to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;fpy_{}_ts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_relevant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase</span><span class="p">,</span> <span class="n">sourcespec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the specified target case identifier matches</span>
<span class="sd">        the specification in self.cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#First check that the test names match.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#We are filtering on a specific test id *and* the existence of that</span>
            <span class="c1">#test in the source specification.</span>
            <span class="n">testok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="o">==</span> <span class="n">sourcespec</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We just need to make sure that the test exists</span>
            <span class="n">testok</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">testok</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">==</span> <span class="s2">&quot;every&quot;</span><span class="p">:</span>
            <span class="c1">#Check whether the specified test case matches any of those for</span>
            <span class="c1">#which we have sample output.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">testcase</span> <span class="ow">in</span> <span class="n">sourcespec</span><span class="o">.</span><span class="n">cases</span> <span class="ow">or</span> <span class="p">(</span><span class="n">testcase</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">sourcespec</span><span class="o">.</span><span class="n">cases</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#Check that the testcase is in our filtering list *and* that it exists</span>
            <span class="c1">#in the set of output (source) test cases.</span>
            <span class="k">return</span> <span class="n">testcase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="ow">and</span> <span class="n">testcase</span> <span class="ow">in</span> <span class="n">sourcespec</span><span class="o">.</span><span class="n">cases</span>
        <span class="k">return</span> <span class="bp">False</span>

<div class="viewcode-block" id="TestSource.path"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSource.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coderoot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stagedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full path to the *source* file that this test source</span>
<span class="sd">        is going to use (either directly or with copy).</span>

<span class="sd">        :arg stagedir: the path to the staging directory to use (override).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
        <span class="kn">from</span> <span class="nn">fortpy.testing.compilers</span> <span class="kn">import</span> <span class="n">replace</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{}.{}.[c]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xinst</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xinst</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">compiler</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_relevant</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">testspec</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="n">stagedir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">stagedir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xinst</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">xinst</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">staging</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#Determine the absolute path using the relative path specified in the group</span>
            <span class="c1">#staging directory attribute.</span>
            <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="n">xinst</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">staging</span><span class="p">)</span>

        <span class="c1">#This is the path to the source output folder that we need to copy from</span>
        <span class="k">if</span> <span class="n">case</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caseid</span> <span class="o">=</span> <span class="s2">&quot;{}.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="n">caseid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">source</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File &#39;{}&#39; for &#39;testsource&#39; does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find source folder for &#39;testsource&#39; at &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="TestSource.copy"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSource.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coderoot</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stagedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copies the test-source file to the specified testing directory.</span>
<span class="sd">        </span>
<span class="sd">        :arg stagedir: the path to the staging directory to use (override).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">stagedir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">testroot</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">_source_testoutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the test output source file information for the specified</span>
<span class="sd">        parameter from a unit test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">executable</span><span class="o">.</span><span class="n">test_group</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">tinst</span> <span class="ow">in</span> <span class="n">executable</span><span class="o">.</span><span class="n">test_group</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">tinst</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">parameter</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">target</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span>
        
    <span class="k">def</span> <span class="nf">_source_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the parameter CodeElement instance defined by the testsource</span>
<span class="sd">        attribute if it was specified. Result is a tuple of (executable, parameter)</span>
<span class="sd">        instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find the test-source {} &#39;{}&#39; for test &#39;{}&#39; in &#39;{}&#39;.&quot;</span>
            <span class="n">tid</span><span class="p">,</span> <span class="n">xid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span>
            <span class="n">mname</span><span class="p">,</span> <span class="n">xname</span><span class="p">,</span> <span class="n">pname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parent</span>
            
            <span class="k">if</span> <span class="n">mname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">load_dependency</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mname</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xname</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mnam</span><span class="p">]</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
                    <span class="n">xinst</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">xname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">xinst</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">xinst</span><span class="p">,</span> <span class="n">xinst</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">pname</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="n">xname</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="n">xname</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="n">mname</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;testsource&#39; attribute requires a list of 3 &quot;</span>
                             <span class="s2">&quot;&#39;.&#39;-separated identifiers &#39;module.executable.parameter&#39;. &quot;</span>
                             <span class="s2">&quot;Specified value was &#39;{}&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testsource</span><span class="p">))</span>               </div>
    
<div class="viewcode-block" id="GlobalDeclaration"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.GlobalDeclaration">[docs]</a><span class="k">class</span> <span class="nc">GlobalDeclaration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a declaration to have a global variable instance available</span>
<span class="sd">    for execution of a unit test.</span>

<span class="sd">    :attr element: the docstring element representing the &lt;global&gt; tag.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of a variable that this variable needs in order</span>
<span class="sd">        to be initialized or assigned a value or &quot;&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the position of a &lt;global&gt; declaration in a testing group relative</span>
<span class="sd">        to the test-local &lt;global&gt; definitions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;before&quot;</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the dimension specification from the &lt;global&gt; tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;dimensions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the kind of the variable from the &lt;global&gt; tag declaration, if </span>
<span class="sd">        it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;kind&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the integer number of dimensions that this variable</span>
<span class="sd">        is declared as having.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specifies whether this variable should be ignored when passed in to argument lists</span>
<span class="sd">        and for definitions etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;ignore&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;ignore&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>

<div class="viewcode-block" id="GlobalDeclaration.value_elem"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.GlobalDeclaration.value_elem">[docs]</a>    <span class="k">def</span> <span class="nf">value_elem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a fortpy.element.ValueElement to represent this GlobalDeclaration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">fortpy.elements</span> <span class="kn">import</span> <span class="n">ValueElement</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="s2">&quot;modifiers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ValueElement</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">modifiers</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
                            <span class="n">default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="GlobalDeclaration.compare"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.GlobalDeclaration.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines whether the specified element defines the same variable</span>
<span class="sd">        type and name as this one.</span>

<span class="sd">        The two are considered equal if they have the same:</span>
<span class="sd">         - name</span>
<span class="sd">         - type</span>
<span class="sd">         - dimensionality</span>
<span class="sd">         - allocatable/pointer modifiers</span>
<span class="sd">        .&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind_check</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_check</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimensions_check</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></div>
            
    <span class="k">def</span> <span class="nf">_kind_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the kind declaration of the element matches this global.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;kind&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="s2">&quot;kind&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="s2">&quot;kind&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="s2">&quot;kind&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_dimensions_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the dimensions of this declaration match the specified</span>
<span class="sd">        element.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;dimensions&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="s2">&quot;dimensions&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="s2">&quot;dimensions&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="s2">&quot;dimensions&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="c1">#The dimension text has to match perfectly. If variables names are specified</span>
            <span class="c1">#for bounds, we have no way of knowing whether the sizes are the same before</span>
            <span class="c1">#runtime. However, we can do some cleanup befor comparing.</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">selfdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">eldim</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#We only need to compare dimensions until one fails</span>
            <span class="k">while</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfdim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">selfdim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">eldim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="k">return</span> <span class="n">match</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_modifier_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether this global var and the specified element match in crucial</span>
<span class="sd">        modifier definitions (i.e. pointer, allocatable).&quot;&quot;&quot;</span>
        <span class="c1">#We need both to have modifiers or not have modifiers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;modifiers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="s2">&quot;modifiers&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="s2">&quot;modifiers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="s2">&quot;modifiers&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">selfmods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span>
            <span class="n">elmods</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span>
            <span class="c1">#At first it seemed like this would be an important check, but a pre-req</span>
            <span class="c1">#could theoretically allocate pointer and then it could be passed into</span>
            <span class="c1">#a routine that just needed a value.</span>
            <span class="c1">#if (&quot;pointer&quot; in selfmods and &quot;pointer&quot; not in elmods) or \</span>
            <span class="c1">#   (&quot;pointer&quot; not in selfmods and &quot;pointer&quot; in elmods):</span>
            <span class="c1">#    return False</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="n">selfmods</span> <span class="ow">and</span> <span class="s2">&quot;allocatable&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elmods</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfmods</span> <span class="ow">and</span> <span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="n">elmods</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of attributes for this global variable declaration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">DocElement</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">attributes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#This handles the case that we are constructing from an XML element rather</span>
            <span class="c1">#than a DocElement</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span>

<div class="viewcode-block" id="GlobalDeclaration.definition"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.GlobalDeclaration.definition">[docs]</a>    <span class="k">def</span> <span class="nf">definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the fortran declaration that defines a global variable.</span>

<span class="sd">        :arg altname: specifies an alternative name to use for this variable; all</span>
<span class="sd">          other variable properties remain the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;  ! Variable &#39;{}&#39; was set to be ignored.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">or</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="s2">&quot;required variable for execution missing some attributes.&quot;</span> <span class="o">+</span> 
                    <span class="s2">&quot; {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">))</span>
            <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;kind&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;character&quot;</span> <span class="ow">and</span> <span class="s2">&quot;len=*&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Assumed length character array defaulting to kind of &#39;len=100&#39;. &quot;</span>
                         <span class="s2">&quot;Use a &lt;global&gt; tag to override this default.&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(100)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]))</span>

        <span class="n">dimalloc</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s2">&quot;dimensions&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">DocElement</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;AUTOPARAM&quot;</span><span class="p">:</span>
                <span class="c1">#We used to force the user to explicitly declare a &lt;global&gt; tag if the</span>
                <span class="c1">#dimensions were fixed; however, we should be able to predict whether it</span>
                <span class="c1">#is necessary: if the dimensions only include digits etc. then it can be</span>
                <span class="c1">#declared as is; otherwise, we replace it with &#39;:&#39;.</span>
                <span class="n">complexdim</span><span class="o">=</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^\d+&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,\s*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">complexdim</span><span class="p">):</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">normal</span><span class="p">:</span>
                <span class="n">dimstr</span> <span class="o">=</span> <span class="s2">&quot;({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dimstr</span> <span class="o">=</span> <span class="s2">&quot;({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;:&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">])]))</span>
                <span class="n">dimalloc</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dimstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;modifiers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">])</span>
            <span class="n">smods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_mods</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dimalloc</span> <span class="ow">and</span> <span class="s2">&quot;allocatable&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">smods</span> <span class="ow">and</span> <span class="s2">&quot;pointer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">smods</span><span class="p">:</span>
                <span class="n">smods</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">smods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;allocatable&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smods</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">smods</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">smods</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; :: &quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dimstr</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dimstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; ={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]))</span>
            
        <span class="k">return</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_clean_mods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mods</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns only those modifiers that belong in a definition statement.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pointer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;allocatable&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<div class="viewcode-block" id="GlobalDeclaration.initialization"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.GlobalDeclaration.initialization">[docs]</a>    <span class="k">def</span> <span class="nf">initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the fortran declaration to initialize the global variable&#39;s value.&quot;&quot;&quot;</span>
        <span class="c1">#See which of the options for initializing the variable were specified</span>
        <span class="c1">#in the docstring.</span>
        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1">#We handle default values at the definition level.</span>
        <span class="k">elif</span> <span class="s2">&quot;mode&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;call &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">et_mode({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#else: result = &quot;! {} had no initialization value specified&quot;.format(self.attributes[&quot;name&quot;])</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">result</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GlobalDeclaration.range_check"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.GlobalDeclaration.range_check">[docs]</a>    <span class="k">def</span> <span class="nf">range_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if this variable has a range check specified and</span>
<span class="sd">        writes the fortran code to compute the check.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;range&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="c1">#The fortpy module has an interface to handle any sorts of types we throw at</span>
            <span class="c1">#it, so we just need to make the call.</span>
            <span class="n">rangecall</span> <span class="o">=</span> <span class="s2">&quot;call fpyin_range({},{},{})&quot;</span>
            <span class="c1">#TODO, we need to create the range variables in the program and assign there</span>
            <span class="c1">#values if range was specified. 2D arrays need a 2D vector of ranges for</span>
            <span class="c1">#each dimension. Need to adjust the fortpy module to accomodate. Call the vars</span>
            <span class="c1">#by paramname_min etc.</span>
            <span class="c1">#We don&#39;t need to use fpyin_range b/c it just calls any/all built-in values.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span></div></div>

<div class="viewcode-block" id="AutoClasser"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AutoClasser">[docs]</a><span class="k">class</span> <span class="nc">AutoClasser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for generating read/save calls in Fortran for complex</span>
<span class="sd">    user-derived types. Ragged arrays are *not* supported.</span>

<span class="sd">    :arg variable: an instance of ValueElement to auto-class.</span>
<span class="sd">    :arg folder: the path to the *parent* folder that houses the &#39;varfile&#39; folder with</span>
<span class="sd">      the contents of the variable.</span>
<span class="sd">    :arg varfile: the name of the folder to create (relative to &#39;folder&#39;) to contain</span>
<span class="sd">      the files for the variable.</span>
<span class="sd">    :arg cases: the TestSpecification instance&#39;s cases that will run.</span>
<span class="sd">    :arg coderoot: the full path to the code folder that houses that executable being</span>
<span class="sd">      unit tested.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">varfile</span><span class="p">,</span> <span class="n">cases</span><span class="p">,</span> <span class="n">coderoot</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">generic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="o">=</span> <span class="n">varfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="n">cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span> <span class="o">=</span> <span class="n">coderoot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ofolder</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="sd">&quot;&quot;&quot;The original folder specification before it got overwritten with the</span>
<span class="sd">        relative one in the fortran program.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic</span> <span class="o">=</span> <span class="n">generic</span>
        <span class="sd">&quot;&quot;&quot;When true, instead of outputing the specific variable name for save and read</span>
<span class="sd">        operations, the generic &#39;variable&#39; will be used as the name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The fortran code to *save* the variable to its folder.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The fortran code to *read* a variable from folder so long as the</span>
<span class="sd">        files are named using the correct convention.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;The variables needed to perform the read/write operations; essentially</span>
<span class="sd">        the same list whether it is input/output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_vcoded</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Specifies whether this auto-classer has already output code to define</span>
<span class="sd">        the variables (for cases where the same variable has its value read,</span>
<span class="sd">        modified and then saved using auto-class).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The order in which the tree&#39;s dimensionalities will be saved in the</span>
<span class="sd">        .fortpy.analysis file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Has the actual file dimensionality for each variable in self.tree_order as</span>
<span class="sd">        extracted from the first auto-class folder that gets scanned. There should be</span>
<span class="sd">        consistency between the folders to match the strongly-typed variables.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AutoClasser.set_folder"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AutoClasser.set_folder">[docs]</a>    <span class="k">def</span> <span class="nf">set_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the folder for the auto-class relative to the *code root*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t set folder to &#39;None&#39;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ofolder</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">r&quot;&#39;//trim(adjustl(fpy_case))//&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span> <span class="ow">in</span> <span class="n">relpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">,</span> <span class="s2">&quot;fpy_coderoot//&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">relpath</span></div>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acroot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The folder path to the auto-class target for read/write, *relative*</span>
<span class="sd">        to 1) code directory for reads; 2) test directory for writes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;{}/{}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

<div class="viewcode-block" id="AutoClasser.abspath"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AutoClasser.abspath">[docs]</a>    <span class="k">def</span> <span class="nf">abspath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the absolute path to the auto-class folder relative to the root</span>
<span class="sd">        directory specified: 1) code root for reads; 2) test execution directory</span>
<span class="sd">        for writes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
        <span class="k">return</span> <span class="n">coderelpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acroot</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoClasser.xcode"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AutoClasser.xcode">[docs]</a>    <span class="k">def</span> <span class="nf">xcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">testsource</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the code to save/read a variable from its auto-class folder.</span>
<span class="sd">        This version uses the `auxsave` and `auxread` interfaces from `fpy_auxiliary`</span>
<span class="sd">        instead of generating all the save and read statements directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Everything is handled internally by the auxiliary module. We don&#39;t have</span>
        <span class="c1">#any additional variables/initialization outside of the ones handled</span>
        <span class="c1">#globally by the &lt;assignment&gt; and &lt;target&gt; objects.</span>
        <span class="n">acroot</span> <span class="o">=</span> <span class="n">testsource</span> <span class="k">if</span> <span class="n">testsource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">acroot</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;vars&quot;</span> <span class="ow">and</span> <span class="s2">&quot;fpy_coderoot&quot;</span> <span class="ow">in</span> <span class="n">acroot</span><span class="p">:</span>
            <span class="n">rootstr</span> <span class="o">=</span> <span class="s2">&quot;{}character({}), parameter :: fpy_coderoot = &#39;{}&#39;&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rootstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;save&quot;</span> <span class="ow">and</span> <span class="n">write</span><span class="p">:</span>
            <span class="n">fstr</span> <span class="o">=</span> <span class="s2">&quot;{}call auxsave({}, &#39;{}&#39;)&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">acroot</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write</span><span class="p">:</span>
            <span class="n">fstr</span> <span class="o">=</span> <span class="s2">&quot;{}call auxread({}, &#39;{}_&#39;)&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">acroot</span><span class="p">))</span></div>
    
    <span class="k">def</span> <span class="nf">_scan_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a tree representation of the specified folder under the assumption</span>
<span class="sd">        that it contains file data for an auto-class read.</span>

<span class="sd">        :arg spath: the full path to the source folder to scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">walk</span><span class="p">,</span> <span class="n">path</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">spath</span><span class="p">):</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
            <span class="k">break</span>
            
        <span class="n">tree</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                <span class="c1">#Ignore files that don&#39;t match the convention.</span>
                <span class="k">continue</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[\d.]+&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                    <span class="c1">#This is a variable name, *not* a dimension specification</span>
                    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
                            <span class="n">tree</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                        <span class="n">branch</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">branch</span><span class="p">:</span>
                            <span class="n">branch</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                        <span class="n">branch</span> <span class="o">=</span> <span class="n">branch</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">_prep_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs an analysis and saves the necessary files for the folder</span>
<span class="sd">        at the specified path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_folder</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
        <span class="n">_read_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span> <span class="o">=</span> <span class="n">_read_dims</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#We only need to save the order for the first folder that we encounter.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">saveorder</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saveorder</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">def</span> <span class="nf">_write_val</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            
        <span class="n">anpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="s2">&quot;.fortpy.analysis&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">saveorder</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_read_dims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">_write_val</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="s2">&quot;.fortpy.tree&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="p">))</span>    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_read_dims</span><span class="p">:</span>
                        <span class="n">_write_val</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_read_dims</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Folder &#39;{}&#39; is missing member variable data &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                    
<div class="viewcode-block" id="AutoClasser.prep_read"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AutoClasser.prep_read">[docs]</a>    <span class="k">def</span> <span class="nf">prep_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets this auto-classer up to handle reading-in from a folder</span>
<span class="sd">        by analyzing the contents of the folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_load_tree_order</span><span class="p">(</span><span class="n">relpath</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Attempts to load the tree order from file for the specified auto-class</span>
<span class="sd">            directory.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">trpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="s2">&quot;.fortpy.tree&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">trpath</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">trpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_load_read_dims</span><span class="p">(</span><span class="n">relpath</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Attempts to load the variable dimensionality from file for the specified</span>
<span class="sd">            auto-class directory.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">anpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="s2">&quot;.fortpy.analysis&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anpath</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">itree</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">itree</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        
        <span class="c1">#For handling multiple cases, it gets a little more complex; we need to</span>
        <span class="c1">#scan every folder that matches a case. All the folders need to use the</span>
        <span class="c1">#same tree order for consistency with the fortran driver.</span>
        <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s2">&quot;{}&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ofolder</span><span class="p">:</span>
            <span class="n">proclist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
                <span class="n">relpath</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ofolder</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">relpath</span><span class="p">):</span>
                    <span class="n">anpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="s2">&quot;.fortpy.analysis&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anpath</span><span class="p">):</span>
                        <span class="n">proclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>

                    <span class="c1">#One of the folders will already have a tree order if we have ever</span>
                    <span class="c1">#processed this variable&#39;s folders before.</span>
                    <span class="n">_load_tree_order</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
                    <span class="n">_load_read_dims</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">relpath</span> <span class="ow">in</span> <span class="n">proclist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prep_single</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relpath</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ofolder</span><span class="p">)</span>
            <span class="n">_load_tree_order</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
            <span class="n">_load_read_dims</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prep_single</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span></div>
                    
    <span class="k">def</span> <span class="nf">_analyze_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>            
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">xkey</span> <span class="o">=</span> <span class="s2">&quot;{}.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xkey</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">result</span><span class="p">[</span><span class="n">xkey</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_branch</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analyze_tree</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">xkey</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
                
    <span class="k">def</span> <span class="nf">_analyze_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memname</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Make sure that the dimensionality is consistent across the files.</span>
            <span class="n">bdim</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">D0</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]:</span>
                <span class="n">D</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">leaf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">bdim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">bdim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
                    <span class="n">D0</span> <span class="o">=</span> <span class="n">D</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">D0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent dimensionality for member &quot;</span>
                                     <span class="s2">&quot;&#39;{}&#39;: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memname</span><span class="p">,</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]))</span>

                <span class="c1">#Now we just need to extract the maximum value in each dimension.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">D0</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bdim</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">bdim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">bdim</span>
        
<div class="viewcode-block" id="AutoClasser.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AutoClasser.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code required to save/read the value of this auto-class to</span>
<span class="sd">        file-folder if the specified position is appropriate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#We assume that whatever is calling the auto-classer has already figured</span>
        <span class="c1">#out whether the position is correct for the read/write code.</span>
        <span class="c1">#Since the procesing generates code for both the read/write *and* the vars, we</span>
        <span class="c1">#need to run it irrespective.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcode</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcode</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wcode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rcode</span><span class="p">)</span>        

        <span class="c1">#For declaring the variables, we only do it once per application, even if we</span>
        <span class="c1">#are performing both a read and a write.</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_vcoded</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}!V: {} auto-class support variables&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;_acps&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}character(100) :: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s2">&quot;_wrote&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}logical :: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}integer :: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_vcoded</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">write</span> <span class="ow">and</span> <span class="s2">&quot;read&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_vcoded</span><span class="p">:</span>
                <span class="c1">#Also append on the ragged-array for handling the dimensionality of</span>
                <span class="c1">#the separate members in the auto-class folder.</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}class(fpy_vararray), allocatable :: {}_fpy_acdims(:)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}integer :: ifpy_ac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>
                    <span class="n">rootstr</span> <span class="o">=</span> <span class="s2">&quot;{}character({}), parameter :: fpy_coderoot = &#39;{}&#39;&quot;</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rootstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_vcoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_vcoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write</span><span class="p">:</span>
            <span class="c1">#Read in the contents of the fortpy analysis into the ragged array</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">if</span> <span class="s2">&quot;fpy_coderoot&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acroot</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">fstr</span> <span class="o">=</span> <span class="s2">&quot;{}call autoclass_analyze({}{}.fortpy.analysis&#39;, {}_fpy_acdims)&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>
        
    <span class="k">def</span> <span class="nf">_process_autovar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">filecontext</span><span class="p">,</span> <span class="n">treecontext</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span>
                         <span class="n">write</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a system to recursively save the contents of a single variable</span>
<span class="sd">        that is a user-derived type with multiple members.</span>

<span class="sd">        :arg variable: an instance of ValueElement representing the type of the variable</span>
<span class="sd">          to save.</span>
<span class="sd">        :arg context: for nested derived types like &#39;type1%type2&#39;, variable would be &#39;type2&#39;</span>
<span class="sd">          and the context would be &#39;type1%&#39;.</span>
<span class="sd">        :arg vslice: if the derived type is part of an array, the slice of the array to</span>
<span class="sd">          generate the pysave for. This will be a list of loop variables.</span>
<span class="sd">        :arg filecontext: the context of the *filename* that the variable values are being</span>
<span class="sd">          saved to.</span>
<span class="sd">        :arg spacer: whitespace to prepend to each line of code generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="n">spacer</span>
        <span class="c1">#Find the effective dimension; since fortpy can save multi-D arrays for simple</span>
        <span class="c1">#data types, those don&#39;t have any effective dimensions. </span>
        <span class="n">effD</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">is_custom</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
        <span class="n">loopvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;{}_ac{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">effD</span><span class="p">)]</span>
        <span class="n">lslice</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loopvars</span><span class="p">)</span>
        <span class="n">pslist</span> <span class="o">=</span> <span class="s2">&quot;{}_acps{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">treecontext</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">ntreecontext</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntreecontext</span> <span class="o">=</span> <span class="s2">&quot;{}.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">treecontext</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">write</span><span class="p">:</span>
            <span class="c1">#Next, we see which line in the analysis file has the dimensionality</span>
            <span class="c1">#information for us to set the limits on the loops.</span>
            <span class="k">if</span> <span class="n">ntreecontext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="p">:</span>
                <span class="n">itree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ntreecontext</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="s2">&quot;{}_fpy_acdims({})</span><span class="si">%i</span><span class="s2">tems({{}})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">itree</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="s2">&quot;size({}{}, {})&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loopvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loopvars</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}do {}=1, {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">loopvar</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>

        <span class="k">if</span> <span class="n">effD</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="s2">&quot;(/ {} /)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lslice</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call fpy_period_join_indices({}, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">pslist</span><span class="p">)</span> <span class="o">+</span>
                          <span class="s2">&quot;{}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">effD</span><span class="p">))</span>
            <span class="n">loopvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pslist</span><span class="p">)</span>

        <span class="c1">#Since the folder that all the files gets saved in is already named with the</span>
        <span class="c1">#highest-level variable&#39;s name, we don&#39;t need to add that to the path.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">filevarname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filevarname</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">filevarname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filevarname</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">is_custom</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">custype</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">customtype</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">custype</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">effD</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic</span><span class="p">:</span>
                        <span class="n">ncontext</span> <span class="o">=</span> <span class="s2">&quot;{}variable({})%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">lslice</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ncontext</span> <span class="o">=</span> <span class="s2">&quot;{}{}({})%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lslice</span><span class="p">)</span>
                    <span class="n">nfilecontext</span> <span class="o">=</span> <span class="s2">&quot;{}{}-&#39;//adjustl(trim({}))//&#39;-&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filecontext</span><span class="p">,</span> <span class="n">filevarname</span><span class="p">,</span> <span class="n">pslist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic</span><span class="p">:</span>
                        <span class="n">ncontext</span> <span class="o">=</span> <span class="s2">&quot;{}variable%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ncontext</span> <span class="o">=</span> <span class="s2">&quot;{}{}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">nfilecontext</span> <span class="o">=</span> <span class="s2">&quot;{}{}-&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filecontext</span><span class="p">,</span> <span class="n">filevarname</span><span class="p">)</span>

                <span class="n">icode</span><span class="p">,</span> <span class="n">ivars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_autovar</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">ncontext</span><span class="p">,</span> <span class="n">nfilecontext</span><span class="p">,</span> <span class="n">ntreecontext</span><span class="p">,</span>
                                                     <span class="n">spacing</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">icode</span><span class="p">)</span>
                <span class="n">loopvars</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ivars</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Yay, we are finally down to the standard type level! Just call it with pysave</span>
            <span class="k">if</span> <span class="n">effD</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;{}{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lslice</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;{}{}-&#39;//trim(adjustl({}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filecontext</span><span class="p">,</span> <span class="n">filevarname</span><span class="p">,</span> <span class="n">pslist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;{}{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filecontext</span><span class="p">,</span> <span class="n">filevarname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}if (allocated({}{})) then&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">spacing</span> <span class="o">+=</span> <span class="s2">&quot;  &quot;</span>
                <span class="k">if</span> <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}if (associated({}{})) then&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">spacing</span> <span class="o">+=</span> <span class="s2">&quot;  &quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">is_custom</span> <span class="ow">and</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">customtype</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">variable</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                    <span class="n">rl</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;nprefix = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;call auxsave_{}0d_({}, nprefix, stack, wrote)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">customtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                                 <span class="n">varname</span><span class="p">))</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">spacing</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rl</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">is_custom</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;private contents&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">customtype</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
                        <span class="n">loopvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}_wrote&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call auxsave({}, {}, .true., {}_wrote)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}wrote = wrote .or. {}_wrote&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}if (.not. {}_wrote) then&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}  call pysave(.false., {}//&#39;-.fpy.blank&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}end if&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filecontext</span><span class="p">,</span> <span class="n">filevarname</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call pysave({}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}wrote = .true.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">))</span>

                <span class="k">if</span> <span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span> <span class="ow">or</span> <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
                    <span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}end if&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#We need to see whether we have allocatable, pointer or fixed dimension variable</span>
                <span class="c1">#and call the relevant interface.</span>
                <span class="n">fstr</span> <span class="o">=</span> <span class="s2">&quot;{}call fpy_read{}({}, &#39;#&#39;, {})&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="s2">&quot;_p&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                      <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[\w]+&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">dimension</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="s2">&quot;_f&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>                                

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">effD</span><span class="p">):</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}end do&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacing</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">loopvars</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">write</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processes a single variable as an auto-class for reading/writing with a single</span>
<span class="sd">        folder full of files for its members.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">write</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prep_read</span><span class="p">()</span>

        <span class="n">quote</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">if</span> <span class="s2">&quot;fpy_coderoot&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acroot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acroot</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic</span> <span class="k">else</span>
                <span class="p">(</span><span class="s2">&quot;prefix//&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">customtype</span><span class="o">.</span><span class="n">recursive</span> <span class="k">else</span> <span class="s2">&quot;folder//&#39;&quot;</span><span class="p">))</span>
        <span class="n">icode</span><span class="p">,</span> <span class="n">ivars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_autovar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">quote</span> <span class="o">+</span> <span class="n">root</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wcode</span> <span class="o">=</span> <span class="n">icode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rcode</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#We need to handle all the allocations for the members based on the actual size of the data</span>
            <span class="c1">#unless they are standard types that will be allocated by the fortpy interfaces.</span>
            <span class="n">flines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">acdims</span> <span class="o">=</span> <span class="s2">&quot;{}_fpy_acdims&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;do ifpy_ac=1, size({}, 1)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acdims</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">itree</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_order</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">varname</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
                    <span class="n">dslice</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;{}(ifpy_ac)</span><span class="si">%i</span><span class="s2">tems({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acdims</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_dims</span><span class="p">[</span><span class="n">v</span><span class="p">]))])</span>
                    <span class="n">alloc</span> <span class="o">=</span> <span class="s2">&quot;{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">dslice</span><span class="p">)</span>
                    <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  if ({}(ifpy_ac)</span><span class="si">%i</span><span class="s2">tems(1) .ne. 0) allocate({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acdims</span><span class="p">,</span> <span class="n">alloc</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;end do&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rcode</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">spacer</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">flines</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rcode</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">icode</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ivars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="n">ivars</span></div>
        
<div class="viewcode-block" id="AssignmentValue"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentValue">[docs]</a><span class="k">class</span> <span class="nc">AssignmentValue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a value that can be assigned to the variable represented</span>
<span class="sd">    by an Assignment instance.</span>

<span class="sd">    :attr xml: the xml &lt;value&gt; tag that this object was created from.</span>
<span class="sd">    :attr parent: the instance of Assignment that owns this value.</span>
<span class="sd">    :attr identifier: the unique identifier of the this value.</span>
<span class="sd">    :attr folder: the folder path relative to the code folder where the</span>
<span class="sd">      file for setting a variable value is found.</span>
<span class="sd">    :attr filename: the name of the file in the source folder.</span>
<span class="sd">    :attr rename: the new name the file should have in the execution folder.</span>
<span class="sd">    :attr constant: if specified, the constant value that the variable will</span>
<span class="sd">      be set to during the unit test.</span>
<span class="sd">    :attr embedded: the name of an embedded procedure in a derived type to</span>
<span class="sd">      run. An error is thrown if the variable is not a derived type.</span>
<span class="sd">    :attr function: exact fortran code for a function call to set the vars value.</span>
<span class="sd">    :attr repeats: if the variable will have its value set as part of a </span>
<span class="sd">      constant-input mode program, this specifies whether it should keep being</span>
<span class="sd">      set during each iteration of the main method being tested.</span>
<span class="sd">    :attr prereq: if not None/False, the embedded method on a derived type will be treated</span>
<span class="sd">      along with all its prereqs as part of the execution chain. This value should be the</span>
<span class="sd">      test identifier of the embedded subroutine&#39;s test spec to use.</span>
<span class="sd">    :attr D: the dimensionality of the data in the file that is setting the variable value.</span>
<span class="sd">    :attr ragged: when true, the lines in a 2D array file are treated individually with</span>
<span class="sd">      some other (embedded or function) value assignment.</span>
<span class="sd">    :attr dtype: for ragged array files, the data type of the values in each row.</span>
<span class="sd">    :attr kind: the kind of each value in the data rows of the ragged array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the assignment value using the &lt;value&gt; tag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prereqs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramlist</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;If this value should be assigned to the member of a derived type,</span>
<span class="sd">        then this is the name of that member.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Overrides the default period joined list of loop variables for &lt;part&gt;</span>
<span class="sd">        or ragged assignment from files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="sd">&quot;&quot;&quot;Specifies whether the value comes from an auto-class structured folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Specifies the module.executable.parameter name whose output from a previous</span>
<span class="sd">        unit test run will be used as input for this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_vars</span><span class="p">,</span>
            <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_init</span><span class="p">,</span>
            <span class="s2">&quot;assign&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_assign</span><span class="p">,</span>
            <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_after</span><span class="p">,</span>
            <span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code_before</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">xmltag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the globally unique identifier for this value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;{}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
       
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the file to use taking renaming into account.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>

<div class="viewcode-block" id="AssignmentValue.livefile"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentValue.livefile">[docs]</a>    <span class="k">def</span> <span class="nf">livefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full path to the file that should be *created* in the</span>
<span class="sd">        specified test directory as part of this assignment. This is only</span>
<span class="sd">        useful for file-based assignments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target</span></div>
        
<div class="viewcode-block" id="AssignmentValue.copy"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentValue.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coderoot</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">stagedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copies the input files needed for this value to set a variable.</span>

<span class="sd">        :arg coderoot: the full path to folder with the code files.</span>
<span class="sd">        :arg testroot: the full path the folder where the test is running.</span>
<span class="sd">        :arg case: the case id for multi-case testing.</span>
<span class="sd">        :arg compiler: the name of the compiler being used for the unit tests.</span>
<span class="sd">        :arg stagedir: the path to the staging directory to use (override).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#We only want to do the copy if we are assigning a value from a file.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
            <span class="kn">from</span> <span class="nn">fortpy.testing.compilers</span> <span class="kn">import</span> <span class="n">replace</span>
            <span class="kn">from</span> <span class="nn">fortpy.utility</span> <span class="kn">import</span> <span class="n">symlink</span>
            <span class="n">relpath</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">)),</span> <span class="n">compiler</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            
            <span class="c1">#For the cases where multiple files specify the values for different</span>
            <span class="c1">#parts of an array, the &lt;value&gt; file specification will have a wildcard</span>
            <span class="c1">#at the position where the array index id will go. We just copy *all* the</span>
            <span class="c1">#input files over that match that definition.</span>
            <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">glob</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)::]</span> <span class="o">==</span> <span class="n">suffix</span><span class="p">:</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">symlink</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livefile</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="p">):</span>
            <span class="c1">#We don&#39;t want to duplicate lots of files all over the system. If they already</span>
            <span class="c1">#exist in an output folder, we should just tell Fortran to get the files from</span>
            <span class="c1">#there. For the copy operation, we set the *path* to the actual data in a file</span>
            <span class="c1">#with the variable name and &#39;ts&#39;: &#39;fpy_var_ts&#39;.</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livefile</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="n">datpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">stagedir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">rewrite</span> <span class="o">=</span> <span class="n">datpath</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rewrite</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">rewrite</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#&lt;fortpy mode=&quot;testsource&quot; copy=&quot;false&quot; /&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentValue.check_prereqs"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentValue.check_prereqs">[docs]</a>    <span class="k">def</span> <span class="nf">check_prereqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether this value element requires an embedded method to be</span>
<span class="sd">        added to the prereq chain of the method writer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#The embedded method could use a pointer so that the method we are</span>
            <span class="c1">#calling is *not* the name of the actual method. We need to find the</span>
            <span class="c1">#instance of the TypeExecutable to locate its actual target.</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">kind</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">finder</span><span class="o">.</span><span class="n">module</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span><span class="p">,</span> <span class="n">typemod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">tree_find</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">module</span><span class="p">,</span> <span class="s2">&quot;types&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The type for embedded method {} cannot be found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedded</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prereqs</span><span class="p">:</span>
                <span class="n">typex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedded</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typex</span><span class="o">.</span><span class="n">pointsto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;{}.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">typex</span><span class="o">.</span><span class="n">pointsto</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;{}.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">typex</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prereqs</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="c1">#Let the MethodFinder use the first testing group test.</span>
                    <span class="n">finder</span><span class="o">.</span><span class="n">add_prereq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">finder</span><span class="o">.</span><span class="n">add_prereq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prereqs</span><span class="p">)</span></div>
 
<div class="viewcode-block" id="AssignmentValue.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentValue.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code lines to initialize the parent variable.</span>

<span class="sd">        :arg lines: the list of strings to append to.</span>
<span class="sd">        :arg position: one of [&#39;vars&#39;, &#39;init&#39;, &#39;assign&#39;, &#39;before&#39;, &#39;after&#39;] indicating </span>
<span class="sd">          where in the fortran program the code will be appended.</span>
<span class="sd">        :arg slices: for array value assignments, the specific indices to assign values</span>
<span class="sd">          to. Tuple of (slice string, [loopvars]).</span>
<span class="sd">        :arg first: if multiple value tags are being executed by the calling parent, this</span>
<span class="sd">          should be true only for the *first* &lt;value&gt; tag processed in the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">position</span><span class="p">](</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">position</span><span class="p">](</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trying to assign a value to an unknown variable {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_code_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls _code_setvar() if we *are* in repeat mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_code_assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls _code_setvar() if we are *not* in repeat mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_autoclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes sure that the autoclass for implementing this variable assignment</span>
<span class="sd">        exists in the parent test specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">varkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">acdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">autoclasses</span>
        <span class="k">if</span> <span class="n">varkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acdict</span><span class="p">:</span>
            <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoClasser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">cases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">coderoot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span><span class="o">.</span><span class="n">varfile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span><span class="o">.</span><span class="n">set_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="nf">_code_setvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends code for assigning the value of the parent variable using</span>
<span class="sd">        this value specification.</span>

<span class="sd">        :arg slices: for array value assignments, the specific indices to assign values</span>
<span class="sd">          to.</span>
<span class="sd">        :arg first: if multiple value tags are being executed by the calling parent, this</span>
<span class="sd">          should be true only for the *first* &lt;value&gt; tag processed in the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
            <span class="n">aclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_autoclass</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">testpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="o">.</span><span class="n">filevar</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">testpath</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">aclass</span><span class="o">.</span><span class="n">xcode</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">testpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#We handle these each individually when no file assignment is present.</span>
            <span class="c1">#The file assigner may handle the embedded and function calls at the right</span>
            <span class="c1">#spot when parts are being assigned.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar_value</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar_value</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_embedded</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code_file</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_code_setvar_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the value of the variable primitively to the specified value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;{}%{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{} = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}({}) = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_code_embedded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends code for calling an embedded method in a derived type,</span>
<span class="sd">        optionally including all its dependencies.</span>

<span class="sd">        :arg varname: in the mode where individual files are being used to set the values</span>
<span class="sd">          of different parts of an array of embedded types, &#39;varname&#39; is the name of the </span>
<span class="sd">          temporary variable created to hold the contents of the file. It will be deallocated</span>
<span class="sd">          after the embedded subroutine is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prereqs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#This is a simple exercise in calling the embedded method. We just </span>
            <span class="c1">#need to track down the parameters list.</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedded</span><span class="p">]</span><span class="o">.</span><span class="n">target</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramlist</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1">#This should be easy, but the compiler automatically passes in the</span>
                <span class="c1">#derived type instance as the first parameter in the method; since</span>
                <span class="c1">#that still shows up in the executable parameter list, we need to</span>
                <span class="c1">#filter it out based on its kind. We assume that it would be first in</span>
                <span class="c1">#the list and have the same kind as the derived type.</span>
                <span class="n">orig_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">ordered_parameters</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">orig_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derived_type</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">orig_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">orig_params</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramlist</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span>  <span class="o">==</span> <span class="s2">&quot;Subroutine&quot;</span><span class="p">:</span>
                <span class="n">call</span> <span class="o">=</span> <span class="s2">&quot;call &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Embedded type initialization routines must be&quot;</span>
                                 <span class="s2">&quot; subroutines, functions aren&#39;t supported.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}{}%{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="s2">&quot;$&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="c1">#The developer is using some existing array and wants the loop variable</span>
                    <span class="c1">#names substituted for some of the paramaters.</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;${}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1">#Handle the embedded via file possibility.</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@file&quot;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>

                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}{}({})%{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
                                                        <span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
        <span class="c1">#if it does have pre-reqs, they will be handled by the method writer and we</span>
        <span class="c1">#don&#39;t have to worry about it.</span>

    <span class="k">def</span> <span class="nf">_code_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">first</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends code for initializing the value of a variable that is a</span>
<span class="sd">        scalar, vector or 2D matrix from a file.</span>

<span class="sd">        :arg first: specifies that this file assignment is the first of a list</span>
<span class="sd">          of &lt;value&gt; tags that are siblings in the same context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">flines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#If we have slices being set from file values, we will have a set</span>
        <span class="c1">#of files that match a wildcard pattern. They will all have been copied</span>
        <span class="c1">#into the test directory. However, we need to replace the wildcard in</span>
        <span class="c1">#the filename at *runtime* with the current value of the loop variable.</span>
        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xname</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lslice</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lslice</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="s2">&quot;${}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
                        <span class="n">lslice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        
            <span class="n">indices</span> <span class="o">=</span> <span class="s2">&quot;(/ {} /)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lslice</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;call fpy_period_join_indices(&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;{}_pslist, {}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lslice</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="c1">#This makes sure that if the wildcard is in the middle of the filename</span>
                <span class="c1">#we still get it right.</span>
                <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
                <span class="n">rtname</span> <span class="o">=</span> <span class="s1">&#39;&quot;{}&quot;//{}_pslist//&quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rtname</span> <span class="o">=</span> <span class="s1">&#39;&quot;{}&quot;//{}_pslist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xname</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xname</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">rtname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="o">.</span><span class="n">filevar</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rtname</span> <span class="o">=</span> <span class="s2">&quot;&#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xname</span><span class="p">)</span>

        <span class="c1">#There is also the case where we want to use a single file, but with ragged data</span>
        <span class="c1">#lengths on each line.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span><span class="p">:</span>
            <span class="n">ragvar</span> <span class="o">=</span> <span class="s2">&quot;{}_rag&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">slices</span> <span class="o">=</span> <span class="p">(</span><span class="n">ragvar</span><span class="p">,</span> <span class="p">[</span><span class="n">ragvar</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Make sure that we have at least one free dimension available for the ragged</span>
                <span class="c1">#list in the file.</span>
                <span class="k">if</span> <span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">:</span>
                    <span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ragvar</span>
                    <span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ragvar</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;ragged&#39; option can only be used when there is &quot;</span>
                                     <span class="s2">&quot;a spare dimension on the array to assign the ragged &quot;</span>
                                     <span class="s2">&quot;file values to.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;{}_fvar&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;{}({})%{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;{}%{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>

        <span class="c1">#We are working with a vector or scalar. Check the dimensionality of</span>
        <span class="c1">#the actual variable and see if it needs to be allocated.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span><span class="p">:</span>
            <span class="c1">#For the ragged option, this is the only place that we handle it.</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;call fpy_linevalue_count({}, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtname</span><span class="p">)</span> <span class="o">+</span>
                          <span class="s2">&quot;&#39;{0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span><span class="p">)</span> <span class="o">+</span> 
                          <span class="s2">&quot;, {0}_nlines, {0}_nvalues)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;allocate({}({}_nlines))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;call fpy_linevalue_count_all({}, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtname</span><span class="p">)</span> <span class="o">+</span>
                          <span class="s2">&quot;&#39;{0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span><span class="p">)</span> <span class="o">+</span> 
                          <span class="s2">&quot;, {0}_nlines, {0}_ragvals)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;open(fpy_newunit({}_funit), &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span> <span class="o">+</span> 
                          <span class="s2">&quot;file={})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtname</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;do {0}_rag=1, {0}_nlines&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  allocate({0}_fvar({0}_ragvals({0}_rag)))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  read({}_funit, *) {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>
                
        <span class="c1">#Now handle the case where the input file fills a 2D variable.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span><span class="p">:</span>
            <span class="n">fmtstr</span> <span class="o">=</span> <span class="s2">&quot;call fpy_read{}({}, &#39;{}&#39;, {})&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">modifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>
                <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span>  <span class="o">==</span> <span class="s2">&quot;ValueElement&quot;</span><span class="p">:</span>
                <span class="c1">#We need to get the code element of the *member* variable and look</span>
                <span class="c1">#at its modifiers instead of the parent.</span>
                <span class="n">custype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">customtype</span>
                <span class="k">if</span> <span class="n">custype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">custype</span><span class="o">.</span><span class="n">members</span><span class="p">:</span>
                    <span class="n">memvar</span> <span class="o">=</span> <span class="n">custype</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    <span class="n">modifiers</span> <span class="o">=</span> <span class="n">memvar</span><span class="o">.</span><span class="n">modifiers</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">memvar</span><span class="o">.</span><span class="n">D</span>
                    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">memvar</span><span class="o">.</span><span class="n">dimension</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The member &#39;{}&#39; is not part of user-derived&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="p">)</span> <span class="o">+</span>
                                     <span class="s2">&quot; type &#39;{}&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">kind</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The variable &#39;{}&#39; is not a user-derived type.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="n">modifiers</span> <span class="ow">and</span> <span class="s2">&quot;fvar&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varname</span><span class="p">):</span>
                <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;_p&quot;</span><span class="p">,</span> <span class="n">rtname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modifiers</span> <span class="ow">and</span> <span class="s2">&quot;fvar&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varname</span> <span class="ow">and</span> <span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                  <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[A-Za-z]+&quot;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)):</span>
                <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;_f&quot;</span><span class="p">,</span> <span class="n">rtname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">rtname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>

        <span class="c1">#Handle the mixture of embed/function and filename case.</span>
        <span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_embedded</span><span class="p">(</span><span class="n">flines</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">filefun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@file&quot;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar_value</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">filefun</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span><span class="p">:</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  deallocate({0}_fvar)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;end do&quot;</span><span class="p">)</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;close({}_funit)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">slices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">flines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;deallocate({0}_fvar)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>

        <span class="c1">#Deallocate the variable for concatenating the loop ids to form the file name</span>
        <span class="c1">#if &quot;*&quot; in self.xname:</span>
        <span class="c1">#    flines.append(&quot;deallocate({0}_pslist)&quot;.format(self.iid))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="n">spacer</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">flines</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_code_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends code for deallocating a variable that was assigned a value.</span>
<span class="sd">        This is useful so that we can reallocate it again in repeat mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">allocate</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span> <span class="ow">or</span>
             <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">modifiers</span><span class="p">)):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}deallocate({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_code_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends code to initialize any variables we need for assignment</span>
<span class="sd">        operations later on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#The test source initialization needs to be coded first since the autoclass</span>
        <span class="c1">#could *also* be specified at the same time. In that case we need the variable</span>
        <span class="c1">#with the full folder name to be available.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spacer</span> <span class="o">+</span> <span class="s2">&quot;!Read the full path to the test-source output data to use.&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call fpy_read(&#39;{}&#39;, &#39;#&#39;, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">filevar</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
            <span class="c1">#We need to analyze the contents of the folder that the variable</span>
            <span class="c1">#is getting its value from and write them to the .fortpy.analysis</span>
            <span class="c1">#file if it doesn&#39;t already exist. The fortran program will suck</span>
            <span class="c1">#that file&#39;s contents to see the sizes for allocating the arrays.</span>
            <span class="n">aclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_autoclass</span><span class="p">()</span>
            <span class="n">aclass</span><span class="o">.</span><span class="n">xcode</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_code_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends lines to declare any variables we need for file read</span>
<span class="sd">        operations later on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="p">:</span>
            <span class="n">vtext</span> <span class="o">=</span> <span class="s2">&quot;{}character(250) :: {} ! test-source path variable&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtext</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="o">.</span><span class="n">varname</span><span class="p">))</span>
        <span class="c1">#It is possible to have testsource and autoclass at the *same* time.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
            <span class="n">aclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_autoclass</span><span class="p">()</span>
            <span class="n">aclass</span><span class="o">.</span><span class="n">xcode</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xname</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wildcard file names and ragged array inputs both require &quot;</span>
                                     <span class="s2">&quot;attribute &#39;dtype&#39; to be specified when attribute &#39;member&#39; &quot;</span>
                                     <span class="s2">&quot;is not present.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">skind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skind</span> <span class="o">=</span> <span class="s2">&quot;({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>

                <span class="n">fdim</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;:&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span>
                
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}!Vars for initializing variable {} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s2">&quot;from file {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}{}, allocatable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">skind</span><span class="p">)</span> <span class="o">+</span> 
                             <span class="s2">&quot; :: {}_fvar({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdim</span><span class="p">)))</span>

            <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xname</span><span class="p">:</span>
                <span class="c1">#This hard-coded 100 assumes that if we have 7 dimensional array and each array</span>
                <span class="c1">#dimension has the maximum size of 4.2 billion for an integer, we would have</span>
                <span class="c1">#(10 characters (4.2 billion) + 1 (period))*7 = 77</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}character(100) :: {}_pslist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{0}integer :: {1}_nlines, {1}_nvalues, {1}_funit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}integer :: {}_rag&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}integer, allocatable :: {}_ragvals(:)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the dimensionality of the variable having its value changed.&quot;&quot;&quot;</span>
        <span class="c1">#We have to do delayed assignment because we don&#39;t have a method finder available in the</span>
        <span class="c1">#parent assignment until a specific test specification is being setup.</span>
        <span class="k">if</span> <span class="s2">&quot;filedim&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;filedim&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">D</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 2D arrays are handled automatically via file assignment.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">D</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">D</span>

    <span class="k">def</span> <span class="nf">_parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts the relevant attributes from the &lt;value&gt; tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;identifier&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We use this for automatic assignment of value identifiers when there</span>
            <span class="c1">#is only one &lt;value&gt; tag and it is unambiguous. The ambiguity is checked</span>
            <span class="c1">#by the parent &lt;assignment&gt; tag.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;member&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;member&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;folder&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;constant&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;embedded&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;embedded&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;function&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;commentchar&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commentchar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;commentchar&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paramlist&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;paramlist&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;rename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;rename&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;repeats&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;repeats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s2">&quot;prereqs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;prereqs&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prereqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;prereqs&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;ragged&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ragged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;ragged&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;dtype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;kind&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;suffix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;$&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;suffix&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="s2">&quot;autoclass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;autoclass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;testsource&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="o">=</span> <span class="n">TestSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;testsource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">testspec</span><span class="p">)</span>
            <span class="c1">#If a test-source is specified, we need to make sure that the relevant</span>
            <span class="c1">#attributes from the source &lt;target&gt; tag get copied over to this &lt;value&gt;.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">autoclass</span></div>

<div class="viewcode-block" id="Condition"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Condition">[docs]</a><span class="k">class</span> <span class="nc">Condition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a single if, elseif or else block to execute.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes using an &lt;if&gt;, &lt;elseif&gt; or &lt;else&gt; tag and an</span>
<span class="sd">        AssignmentConditional instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">tag</span>
        
        <span class="k">if</span> <span class="s2">&quot;condition&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;else&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;condition&#39; is a required attribute for &lt;if&gt; and&quot;</span>
                             <span class="s2">&quot; &lt;elseif&gt; tags.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;value&#39; is a required attribute of &lt;if&gt;, &lt;elseif&gt;&quot;</span>
                             <span class="s2">&quot; and &lt;else&gt; tags.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if any of the values this conditional references have</span>
<span class="sd">        the repeat attribute set to true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">values</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">repeats</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>  
        
<div class="viewcode-block" id="Condition.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Condition.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code for this condition and its variable assignment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;elseif&quot;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{} ({}) then&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else&quot;</span><span class="p">)</span>

        <span class="c1">#Append the value assignment. To do this we have to look it up in the</span>
        <span class="c1">#grand-parents list of possible value assignments.</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">valobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">valobj</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="n">spacer</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not find value &#39;{}&#39; for condition.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span></div></div>
        
<div class="viewcode-block" id="AssignmentConditional"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentConditional">[docs]</a><span class="k">class</span> <span class="nc">AssignmentConditional</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a series of logical tests to perform, each of which results</span>
<span class="sd">    in a different value being assigned to the variable.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes using a &lt;conditionals&gt; tag and Assignment instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;elseif&quot;</span><span class="p">,</span> <span class="s2">&quot;else&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the list of possible value objects from the parent</span>
<span class="sd">        Assignment object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if any of the values used by this condition are</span>
<span class="sd">        repeatable. In that case, the entire block needs to be repeated.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">repeats</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="o">=</span> <span class="bp">False</span>                

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span>

<div class="viewcode-block" id="AssignmentConditional.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.AssignmentConditional.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the lines to form the entire conditional code block of</span>
<span class="sd">        variable assignments.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> 
            <span class="p">((</span><span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">))):</span>

            <span class="c1">#Make sure the first condition is an if and not something else</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;if&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The first condition in a logic block must be &#39;if&#39;.&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}end if&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="Part"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Part">[docs]</a><span class="k">class</span> <span class="nc">Part</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a part assignment for a &lt;part&gt; tag to set specific dimensions on</span>
<span class="sd">    an array-valued variable.</span>

<span class="sd">    :attr identifier: the unique identifier for the &lt;part&gt;.</span>
<span class="sd">    :attr start: the index of the array to start on.</span>
<span class="sd">    :attr value: the value to assign to parts of the array specified by this part.</span>
<span class="sd">    :attr limits: a comma-separated list of integer indices to assign the value to</span>
<span class="sd">      or a range of min-max integer dimension specifiers. The loop generated by this</span>
<span class="sd">      part tag will run over these values.</span>
<span class="sd">    :attr parts: a dict of parts nested in this one.</span>
<span class="sd">    :attr depth: the depth of this part in a nested part specification.</span>
<span class="sd">    :attr assignment: the parent instance of Assignment for this part, even if its</span>
<span class="sd">      immediate parent is another Part instance.</span>
<span class="sd">    :attr isloop: for a limit specificaton that is a comma-separated list, we don&#39;t</span>
<span class="sd">      use a loop, only a repeated list of assignments.</span>
<span class="sd">    :attr loopid: the name of the loop variable for this part.</span>
<span class="sd">    :attr slice_list: list of the dimension specifcations for setting the array part that this</span>
<span class="sd">      object is supposed to set.</span>
<span class="sd">    :attr repeats: when operating in constant mode, should the part assignment happen before</span>
<span class="sd">      each call to the main function being unit tested.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span> <span class="o">=</span> <span class="n">parent</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">)</span> <span class="k">else</span> <span class="n">parent</span><span class="o">.</span><span class="n">assignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">)</span> <span class="k">else</span> <span class="n">parent</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loopid</span> <span class="o">=</span> <span class="s2">&quot;{}_fpy_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">#We can&#39;t determine the remaining attributes until the XML has been parsed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_list</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;:&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">parent</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">)</span> 
                           <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">slice_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopid</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span> <span class="k">else</span> <span class="s2">&quot;{}&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slices</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_top_parts</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1">#Lazy assignment for property.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">top_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the parent &lt;part&gt; instances from a set of nested &lt;part&gt; tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_parts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_top_parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Part</span><span class="p">):</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">parent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_top_parts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_parts</span>
    
    <span class="k">def</span> <span class="nf">_code_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends lines to declare any variables we need for file read</span>
<span class="sd">        operations later on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}!V: {} array-part assignment loop&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}integer :: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopid</span><span class="p">))</span>

<div class="viewcode-block" id="Part.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Part.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the code to make this part specification (and loop) work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code_vars</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="s2">&quot;assign&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_set</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_code_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the code to set up the variable assignment with this loop at position</span>
<span class="sd">        &#39;before&#39; or &#39;assign&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Before we can assign a value, we need to make sure the value identifier is valid</span>
        <span class="c1">#if it exists.</span>
        <span class="k">for</span> <span class="n">valueid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">valueid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">valueid</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;{} in part {} is not &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valueid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="o">+</span> 
                                 <span class="s2">&quot;a valid identifier.&quot;</span><span class="p">)</span>
            
        <span class="c1">#Before we attempt to assign values, we need to make sure that the variable is allocated</span>
        <span class="c1">#For non-file allocations, the Assignment instance handles allocation; for file types,</span>
        <span class="c1">#usually the AssignmentValue instance handles it, except when &lt;part&gt; tags are used.</span>
        <span class="c1">#However, if the tag has multiple &lt;value&gt; references, we only need to allocate *once* for</span>
        <span class="c1">#the variable referenced by the &lt;assignment&gt; tag.</span>
        <span class="n">hasfile</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">hasfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">allocate</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">allocate</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}allocate({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Using allocate=&quot;true&quot; for a &lt;part&gt; tag is not valid &#39;</span>
                                         <span class="s1">&#39;for multi-dimensional arrays; specify the dimensionality &#39;</span>
                                         <span class="s1">&#39;explicitly: e.g. allocate=&quot;size(N, 1)&quot; or allocate=&quot;10,5&quot;.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}allocate({}({}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">allocate</span><span class="p">))</span>            

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}do {}={}, {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">valueid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">valueid</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> 
                                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_list</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We need to repeat the assignment for each of the part values</span>
            <span class="k">for</span> <span class="n">ipart</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">:</span>
                <span class="n">slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slices</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ipart</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">valueid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">valueid</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> 
                                                         <span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_list</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}end do&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loopvar_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replaces the $i value in the specified limit with the relevant loop variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#The loop variables have to be one this part&#39;s parent &lt;part&gt; tags. If it has</span>
        <span class="c1">#no parents, or limit is not a string, we don&#39;t have to do anything.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">limit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_parts</span><span class="p">)):</span>
                <span class="n">rstr</span> <span class="o">=</span> <span class="s2">&quot;${}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rstr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_parts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loopid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">limit</span>

    <span class="k">def</span> <span class="nf">_parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;identifier&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;identifier&#39; attribute is required for &lt;part&gt; tags.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;limits&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopvar_replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopvar_replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;size({}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isloop</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;size({}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;repeats&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;repeats&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>

        <span class="k">for</span> <span class="n">kid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kid</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;part&quot;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="n">kid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents an instance value assignment as part of a pre-req chain.</span>

<span class="sd">    :attr element: the DocElement instance for the &lt;assignment&gt; tag that this</span>
<span class="sd">      assignment object represents.</span>
<span class="sd">    :attr parent: the MethodFinder instance who owns this assignment.</span>
<span class="sd">    :attr methods: a list that will never get used; needed for compatibility</span>
<span class="sd">      with method.MethodWriter._order_dependencies recursion.</span>
<span class="sd">    :attr group: the parent TestingGroup instance, even if the immediate parent</span>
<span class="sd">      is not a testing group.</span>
<span class="sd">    :attr name: the name of the variable whose value will be set.</span>
<span class="sd">    :attr conditionals: a list of &#39;if&#39; blocks that conditionally set the value</span>
<span class="sd">      of the variable at run-time.</span>
<span class="sd">    :attr values: a dict of AssignmentValues capable of setting the variable</span>
<span class="sd">      value from a constant, function, file or by calling an embedded method </span>
<span class="sd">      if the variable is an instance of a derived type.</span>
<span class="sd">    :attr allocate: when true, the variable having its value set will be</span>
<span class="sd">      allocated by this assignment object rather than some other method called</span>
<span class="sd">      previously. Default is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="sd">&quot;&quot;&quot;An instance of TestSpecification or TestingGroup in which this &lt;assignment&gt;</span>
<span class="sd">        was defined.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">TestingGroup</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">testgroup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditionals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writekey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Establishes a unique key for the driver writer so that multiple assignments</span>
<span class="sd">        of the same variable don&#39;t interfere with each other.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>
        <span class="sd">&quot;&quot;&quot;If a test specification includes assignments local to the test then *global*</span>
<span class="sd">        &lt;assignments&gt; attached to the testing group are added either before/after the</span>
<span class="sd">        local assignments. This value specifies that position relative to the local ones.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#Instances can have their values changed by:</span>
        <span class="c1"># - direct assignment to a constant value or function call.</span>
        <span class="c1"># - direct assignment as part of a set of logical tests.</span>
        <span class="c1"># - from the contents of a file.</span>
        <span class="c1"># - by calling an embedded method within a derived type.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">autoclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if any of the assignment values in an autoclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">autoclass</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">testspec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The currently active test specification for which this Assignment instance</span>
<span class="sd">        is being coded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">finder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">test</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns this Assignment&#39;s parent&#39;s CodeParser instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parent</span>
    
<div class="viewcode-block" id="Assignment.global_attr"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Assignment.global_attr">[docs]</a>    <span class="k">def</span> <span class="nf">global_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retuns the value of attribute with the specified key from the GlobalDeclaration</span>
<span class="sd">        instance for this variable being assigned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globaldecl</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">globaldecl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the GlobalDeclaration instance for the current variable, which may have</span>
<span class="sd">        different parameters and modifiers than the actual code element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#We need to give preference to the test specification if it is available.</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">finder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">variables</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">variables</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the ValueElement instance that this assignment refers to.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#Search the global declarations for the variable and then track down</span>
            <span class="c1">#the code element that it represents</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">globaldecl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">module</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globaldecl</span><span class="o">.</span><span class="n">value_elem</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides one-level-up access to the XML elements attributes collection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">DocElement</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">attributes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allocatable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if the variable assigned by this object should be allocated.&quot;&quot;&quot;</span>
        <span class="c1">#We use the global declaration&#39;s attributes when deciding how to treat the </span>
        <span class="c1">#variable in the unit testing application. This is because the developer can</span>
        <span class="c1">#override some of the variable&#39;s behavior with &lt;global&gt; tags and we need to</span>
        <span class="c1">#honor those changes.</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="ow">and</span> 
                <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="c1">#If the dimension is a complicated set of functions or variable names, then</span>
                 <span class="c1">#we can&#39;t initialize it except with &#39;:&#39; and allocatable. That gets added by</span>
                 <span class="c1">#the GlobalDeclaration.definition(), so add this check here.</span>
                 <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[\w]+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span>
    
<div class="viewcode-block" id="Assignment.check_prereqs"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Assignment.check_prereqs">[docs]</a>    <span class="k">def</span> <span class="nf">check_prereqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks all the values this assignment may use to make sure they reference</span>
<span class="sd">        a valid derived type. If an AssignmentValue specifies to check pre-reqs, </span>
<span class="sd">        they are added to the pre-req chain.</span>

<span class="sd">        :arg finder: the instance of MethodFinder for which the pre-reqs are being</span>
<span class="sd">          checked and added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">check_prereqs</span><span class="p">(</span><span class="n">finder</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.copy"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Assignment.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coderoot</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">stagedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copies the input files needed for this assignment to set a variable.</span>

<span class="sd">        :arg coderoot: the full path to folder with the code files.</span>
<span class="sd">        :arg testroot: the full path the folder where the test is running.</span>
<span class="sd">        :arg case: the case id for multi-case testing.</span>
<span class="sd">        :arg compiler: the name of the compiler used to make the unit test executable.</span>
<span class="sd">        :arg stagedir: the path to the staging directory to use (override).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Just call copy on all the child value objects.</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">stagedir</span><span class="p">)</span>        </div>
        
    <span class="k">def</span> <span class="nf">_code_setvar_allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocates the variables before a general value setting if they need to be</span>
<span class="sd">        allocated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#This only works if the value they specified includes a specific allocate dimension</span>
        <span class="c1">#or we can easily determine what it needs to be.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">globaldecl</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">globaldecl</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">dimension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocatable</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">D</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}allocate({}({}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="s2">&quot;class&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_attr</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}allocate({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}allocate({}({}))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">))</span>

<div class="viewcode-block" id="Assignment.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.Assignment.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code for this assignment to function correctly at the</span>
<span class="sd">        specified position in the code file.</span>

<span class="sd">        :arg lines: the list of strings that form the code file.</span>
<span class="sd">        :arg position: one of [&#39;vars&#39;, &#39;init&#39;, &#39;assign&#39;, &#39;before&#39;, &#39;after&#39;] corresponding</span>
<span class="sd">          to variable declaration, initialization, assignment and cleanup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">]:</span>
            <span class="c1">#Recognizing that even though the main &lt;assignment&gt; may reference only a single</span>
            <span class="c1">#&lt;value&gt; or &lt;part&gt; tag, because of nested parts we probably still need to do</span>
            <span class="c1">#the initializations.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">]:</span>
            <span class="c1">#Usually, before any kind of assignment can take place, the variable may need</span>
            <span class="c1">#to be allocated. Here we try allocation for the variable if it applies. For</span>
            <span class="c1">#file variables, the allocation requires special values extracted at runtime</span>
            <span class="c1">#from the input files.</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">repeats</span> <span class="ow">and</span> <span class="n">position</span><span class="o">==</span><span class="s2">&quot;before&quot;</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="p">(</span><span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">repeats</span> <span class="ow">and</span> <span class="n">position</span><span class="o">==</span><span class="s2">&quot;assign&quot;</span><span class="p">))):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar_allocate</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
                    <span class="c1">#We only need to allocate the variable once per assignment.</span>
                    <span class="k">break</span>

            <span class="c1">#We also need to handle the case where the developer only wants the variable</span>
            <span class="c1">#to be allocated and have nothing else done to it...</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="ow">and</span> <span class="n">position</span><span class="o">==</span><span class="s2">&quot;assign&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code_setvar_allocate</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>

            <span class="c1">#We just need to check whether this assignment had an explicit</span>
            <span class="c1">#value or if it has a list of conditionals.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditionals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditionals</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1">#We allow multiple &lt;values&gt; to be assigned in the context of the current</span>
                <span class="c1">#coding. They go in the order they showed up in the list.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value identifier {} not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span></div>
        
    <span class="k">def</span> <span class="nf">_parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses attributes and child tags from the XML element.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;[default]&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_fpy&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;name&#39; is a required attribute for &lt;assignment&gt; tags.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">autoval</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Creates an automatic AssignmentValue instance for the specified</span>
<span class="sd">            attribute and value.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">AssignmentValue</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">val</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="s2">&quot;constant&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="c1">#We want to manually create an AssignmentValue object for the constant and</span>
            <span class="c1">#add it to the child list.</span>
            <span class="n">autoval</span><span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;testsource&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">tsource</span> <span class="o">=</span> <span class="n">TestSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;testsource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="p">)</span>
            <span class="n">autoval</span><span class="p">(</span><span class="s2">&quot;testsource&quot;</span><span class="p">,</span> <span class="n">tsource</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;testsource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="n">tsource</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">autoclass</span>
            
        <span class="k">if</span> <span class="s2">&quot;allocate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;allocate&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;allocate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;allocate&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>        

        <span class="n">kids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">xml</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">DocElement</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">AssignmentValue</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="c1">#Having automation of value identifiers disabled the check to make</span>
                <span class="c1">#sure that every &lt;value&gt; tag has a unique one. Perform that check now.</span>
                <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;identifier&#39; is a required attribute of &lt;value&gt; tags &quot;</span>
                                     <span class="s2">&quot;unless there is only one of them in the &lt;assignment&gt;.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;part&quot;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;conditionals&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditionals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AssignmentConditional</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        
        <span class="c1">#Construct the key for identifying this assignment operation uniquely.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writekey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writekey</span> <span class="o">+=</span> <span class="s2">&quot;({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writekey</span> <span class="o">+=</span> <span class="s2">&quot;_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

        <span class="c1">#If we only have a single value without any fancy conditionals etc.</span>
        <span class="c1">#then the value identifier and attribute are unnecessary.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditionals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span></div>
         
<div class="viewcode-block" id="TestInput"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestInput">[docs]</a><span class="k">class</span> <span class="nc">TestInput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents information for a single input source as part of a unit test.</span>

<span class="sd">    :attr xml: the &lt;input&gt; tag that this object was created from.</span>
<span class="sd">    :attr folder: the path to the folder that contains the input file relative</span>
<span class="sd">      to the code root.</span>
<span class="sd">    :attr filename: the name of the file to use as input.</span>
<span class="sd">    :attr rename: the new name to use for the input file for actual execution.</span>
<span class="sd">    :attr line: a FileLine instance describing the values that appear in a single</span>
<span class="sd">      line of the input file. Use for constant-input mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">,</span> <span class="n">testspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        :arg testspec: the TestSpecification parent instance that has access</span>
<span class="sd">          to code element information for test-source inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span> <span class="o">=</span> <span class="n">testspec</span>
        <span class="sd">&quot;&quot;&quot;TestSpecification parent instance that has access</span>
<span class="sd">          to code element information for test-source inputs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Specifies the module.executable.parameter name whose output from a previous</span>
<span class="sd">        unit test run will be used as input for this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml</span><span class="p">()</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">constant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if operating in constant-input mode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the identifier for this input file when running in constant-</span>
<span class="sd">        input mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fileunit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name used for the variable that holds the file unit</span>
<span class="sd">        for reading the file in constant-input mode.&quot;&quot;&quot;</span>
        <span class="c1">#Come up with a name for the file unit that will be unique; since the</span>
        <span class="c1">#line template has to have an identifier, use that.</span>
        <span class="k">return</span> <span class="s2">&quot;fpy_file_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the variable that holds the number of times to repeat </span>
<span class="sd">        the read operation and execute the method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;fpy_repeat_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iostat_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the variable that holds read IOSTAT for the</span>
<span class="sd">        read operations when running in constant-input mode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;fpy_iostat_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the file that will be in the testing folder</span>
<span class="sd">        at run-time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#We don&#39;t need to take cases into account because the file must be</span>
        <span class="c1">#renamed when running in case mode.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>

<div class="viewcode-block" id="TestInput.code_vars"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestInput.code_vars">[docs]</a>    <span class="k">def</span> <span class="nf">code_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the fortran code for declaring any variables need to run </span>
<span class="sd">        the constant-input mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}!Constant-input mode variables for {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}integer :: {}, {}, {} = 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileunit</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">iostat_read</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestInput.code_init"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestInput.code_init">[docs]</a>    <span class="k">def</span> <span class="nf">code_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the initialization code required for opening the input file</span>
<span class="sd">        when running in constant-input mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="n">dlines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#We need to open the file with a new file unit, which we can do using</span>
            <span class="c1">#the fpy_newunit() function in the fortpy module.</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;!Auto-generated for {}; determine number of constants.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iid</span><span class="p">))</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;open(fpy_newunit({}), file=&#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileunit</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">runfile</span><span class="p">))</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;do&quot;</span><span class="p">)</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  read({}, *, IOSTAT={})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileunit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iostat_read</span><span class="p">))</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  if ({} == 0) then&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iostat_read</span><span class="p">))</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    {0} = {0} + 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repeats</span><span class="p">))</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  else&quot;</span><span class="p">)</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    exit&quot;</span><span class="p">)</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  end if&quot;</span><span class="p">)</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;end do&quot;</span><span class="p">)</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;rewind({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileunit</span><span class="p">))</span>
            <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">spacer</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dlines</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestInput.code_read"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestInput.code_read">[docs]</a>    <span class="k">def</span> <span class="nf">code_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the fortran code for reading the values from the file into</span>
<span class="sd">        the global variables for a single iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="c1">#Use the line parser information to put together a read format string</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">unique_names</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}read({}, *) {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileunit</span><span class="p">,</span> <span class="n">varlist</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="TestInput.code_finalize"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestInput.code_finalize">[docs]</a>    <span class="k">def</span> <span class="nf">code_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code to finalize the constant-input operation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}close({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileunit</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestInput.copy"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestInput.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coderoot</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stagedir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copies the input file from the specified code root directory to</span>
<span class="sd">        the folder where the test is being performed. Alternatively, the file is</span>
<span class="sd">        just symlinked if that is the global setting.</span>

<span class="sd">        :arg coderoot: the full path to the folder that houses all the code files.</span>
<span class="sd">        :arg testroot: the full path to the folder that the parent test is being</span>
<span class="sd">          performed in.</span>
<span class="sd">        :arg case: if a specific case of the same test is being performed, the</span>
<span class="sd">          case identifier to use for string formatting.</span>
<span class="sd">        :arg compiler: the name of the compiler used to make the unit test executable.</span>
<span class="sd">        :arg stagedir: the path to the staging directory to use (override).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
            <span class="kn">from</span> <span class="nn">fortpy.testing.compilers</span> <span class="kn">import</span> <span class="n">replace</span>
            <span class="n">relpath</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">)),</span> <span class="n">compiler</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">fortpy.utility</span> <span class="kn">import</span> <span class="n">symlink</span>
            <span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="n">testroot</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">stagedir</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts the input file attributes from the xmltag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;folder&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;rename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;rename&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;testsource&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testsource</span> <span class="o">=</span> <span class="n">TestSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;testsource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_lines</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for the existence of a &lt;line&gt; tag in the input specification.</span>
<span class="sd">        If it exists, the line attribute is initialized with a FileLine object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">FileLine</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="TestOutput"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestOutput">[docs]</a><span class="k">class</span> <span class="nc">TestOutput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents an output file *compare* operation that needs to be performed</span>
<span class="sd">    by the tester.</span>

<span class="sd">    :attr xml: the XML &lt;output&gt; tag that the object was created from.</span>
<span class="sd">    :attr identifier: the unique identifier for this output specification.</span>
<span class="sd">    :attr folder: for file-mode, the folder that contains &#39;file&#39;.</span>
<span class="sd">    :attr filename: the name of the model file to compare the output to.</span>
<span class="sd">    :attr template: the name of the XML file that has template information</span>
<span class="sd">      for comparing the file.</span>
<span class="sd">    :attr mode: the comparison mode for the FileComparer. Default=&#39;default&#39;.</span>
<span class="sd">    :attr value: if the output value is a constant, its value.</span>
<span class="sd">    :attr tolerance: for value comparisons, as long as the values are within</span>
<span class="sd">      this percent, the test still passes. E.g. if tolerance=0.8, then a value</span>
<span class="sd">      of 0.92 is considered equivalent to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the output comparison using an &lt;output&gt; tag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="sd">&quot;&quot;&quot;Specifies whether the output is running in auto-class mode where entire</span>
<span class="sd">        arrays of user-defined objects can be compared using a single tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actolerance</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Specifies the individual tolerance limit for any single file comparison</span>
<span class="sd">        in the auto-class comparision.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_attributes</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filemode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a value indicating whether the output comparison is with</span>
<span class="sd">        a file (as opposed to a hard-coded value).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span>

<div class="viewcode-block" id="TestOutput.abspath"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestOutput.abspath">[docs]</a>    <span class="k">def</span> <span class="nf">abspath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coderoot</span><span class="p">,</span> <span class="n">caseid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the absolute path to the output file referenced by this</span>
<span class="sd">        output comparison specifier.</span>

<span class="sd">        :arg coderoot: the full path to the directory storing the code files.</span>
<span class="sd">        :arg case: if a specific case of the same test is being performed, the</span>
<span class="sd">          case identifier to use for string formatting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#The caseid is the &quot;testid.case&quot;. We only want the &#39;case&#39; part of it</span>
        <span class="kn">from</span> <span class="nn">fortpy.tramp</span> <span class="kn">import</span> <span class="n">coderelpath</span>
        <span class="kn">from</span> <span class="nn">fortpy.testing.compilers</span> <span class="kn">import</span> <span class="n">replace</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">coderelpath</span><span class="p">(</span><span class="n">coderoot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caseid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">caseid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
                <span class="n">formpath</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
                <span class="n">formpath</span> <span class="o">=</span> <span class="n">relpath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1">#Finally, replace the compiler attributes [c] and [f] for the file path.</span>
        <span class="k">if</span> <span class="n">compiler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cpath</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">formpath</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">formpath</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">formpath</span></div>

    <span class="k">def</span> <span class="nf">_parse_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts output comparsion related attributes from the xml tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;identifier&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;identifier&#39; is a required attribute for an &lt;output&gt; tag.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;folder&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;template&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;mode&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;tolerance&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="s2">&quot;actolerance&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actolerance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;actolerance&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actolerance</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;autoclass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;autoclass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;true&quot;</span>    </div>
        
<div class="viewcode-block" id="TestTarget"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestTarget">[docs]</a><span class="k">class</span> <span class="nc">TestTarget</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a specification to save the state of a variable at the end</span>
<span class="sd">    of the program run *or* each time the main method being tested is run.</span>

<span class="sd">    :attr xml: the xml &lt;target&gt; tag that the object was created from.</span>
<span class="sd">    :attr name: the name of the variable that will be saved.</span>
<span class="sd">    :attr varfile: if fortpy is handling the save to file, the name of the file</span>
<span class="sd">      that fortpy should save the variable under.</span>
<span class="sd">    :attr when: specifies how often the variable should be saved. Possible values</span>
<span class="sd">      are [&#39;begin&#39;, &#39;each&#39;, &#39;end&#39;] corresponding to the start of the program,</span>
<span class="sd">      each time the method gets run and right before the variables are cleaned up</span>
<span class="sd">      by the program.</span>
<span class="sd">    :attr generator: the name of a subroutine to call that will save the variable</span>
<span class="sd">      to a file. The only parameter passed to the subroutine is the instance of the</span>
<span class="sd">      variable to save.</span>
<span class="sd">    :attr compareto: the identifier of an &lt;output&gt; tag that the variable&#39;s values will</span>
<span class="sd">      be compared to after the program has run.</span>
<span class="sd">    :attr testspec: the parent test specification that this target belongs to.</span>
<span class="sd">    :attr member: the name of a member in a derived type whose value should be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">,</span> <span class="n">testspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the target specification with a &lt;target&gt; tag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compareto</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span> <span class="o">=</span> <span class="n">testspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="sd">&quot;&quot;&quot;Specifies whether the output is running in auto-class mode where entire</span>
<span class="sd">        arrays of user-defined objects can be compared using a single tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The code to *save* the variable referenced by this target to file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_attributes</span><span class="p">()</span>

<div class="viewcode-block" id="TestTarget.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestTarget.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code required to save the value of this target to</span>
<span class="sd">        file if the specified position is appropriate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#If the target is trying to get a file to be compared to another</span>
        <span class="c1">#model output file, then it must start with a dot. In that case</span>
        <span class="c1">#we don&#39;t generate any code since we assume that the file is being</span>
        <span class="c1">#created by the method being unit tested.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;vars&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
            <span class="n">varkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_autoclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">autoclasses</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span><span class="o">.</span><span class="n">xcode</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">first</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTarget.init"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestTarget.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testroot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates any directories that this test target needs to function correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span>
            <span class="n">vardir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">vardir</span><span class="p">):</span>
                <span class="n">mkdir</span><span class="p">(</span><span class="n">vardir</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTarget.clean"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestTarget.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testroot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes the output file for saving the variable&#39;s value from the</span>
<span class="sd">        testing folder.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                    <span class="n">rmtree</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                    <span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processes the code to generate the output of the unit test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_autoclass</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_simple</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_autoclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes sure that the autoclass for implementing this variable assignment</span>
<span class="sd">        exists in the parent test specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">varkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">acdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">autoclasses</span>
        <span class="k">if</span> <span class="n">varkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acdict</span><span class="p">:</span>
            <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoClasser</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">cases</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">coderoot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
            <span class="n">acdict</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span><span class="o">.</span><span class="n">varfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span>

        <span class="k">return</span> <span class="n">varkey</span>
            
    <span class="k">def</span> <span class="nf">_process_autoclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processes the test target using an AutoClasser().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#See the comments in _process_simple about these logic trees.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;[default]&quot;</span><span class="p">:</span>
            <span class="n">varkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_autoclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">glob</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glob</span><span class="p">,</span> <span class="n">GlobalDeclaration</span><span class="p">):</span>
                <span class="n">finder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">finder</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">value_elem</span><span class="p">(</span><span class="n">finder</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">glob</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;ValueElement&quot;</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">glob</span>
            <span class="n">varkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_autoclass</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Output target auto-class &#39;{}&#39; has not&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot; been initialized with a &lt;global&gt; tag or regular=true parameter doc tag.&quot;</span><span class="p">)</span>

        <span class="n">icode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">autoclasses</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span><span class="o">.</span><span class="n">xcode</span><span class="p">(</span><span class="n">icode</span><span class="p">,</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">icode</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_process_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processes a single outcome involving a variable value comparison.</span>

<span class="sd">        :arg variables: a list of the GlobalDeclarations made for the unit test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#The framework allows the developer to specify a subroutine to create the</span>
        <span class="c1">#output file for comparison. If one was specified, just use that.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s2">&quot;{}call {}({}, &#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span> 
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s2">&quot;{}call {}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We need to use the fortpy module or the variables own test_output()</span>
            <span class="c1">#to create a file that can be compared later by python. This means</span>
            <span class="c1">#that we need to know the type and kind of the variable whose value</span>
            <span class="c1">#needs to be compared</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;[default]&quot;</span><span class="p">:</span>
                <span class="c1">#We need to save the value that was generated by the main *function* being</span>
                <span class="c1">#unit tested. The variable defined in the fortpy program is the function</span>
                <span class="c1">#name with a suffix of &quot;_fpy&quot;.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s2">&quot;{}call pysave({}_fpy, &#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testspec</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">glob</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;class&quot;</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{}call pysave({}%{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="p">)</span> <span class="o">+</span> 
                                      <span class="s2">&quot;, &#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s2">&quot;{}call {}%test_output(&#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#pysave is an interface in the fortpy module that can accept variables</span>
                    <span class="c1">#of different types and write them to file in a deterministic way</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s2">&quot;{}call pysave({}, &#39;{}&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Output target var {} has not been initialized with &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="s2">&quot;a &lt;global&gt; tag or regular=true parameter doc tag.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts implemented attributes from the test target.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;name&#39; is a required attribute for a &lt;target&gt; tag.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;varfile&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;varfile&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varfile</span> <span class="o">=</span> <span class="s2">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;when&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;when&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;generator&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;generator&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;compareto&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compareto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;compareto&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;member&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;member&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;autoclass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;autoclass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;true&quot;</span></div>

<div class="viewcode-block" id="TestSpecification"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification">[docs]</a><span class="k">class</span> <span class="nc">TestSpecification</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a single test that needs to be performed. Each test compiles</span>
<span class="sd">    a new executable with the same name as the test identifier; however, the</span>
<span class="sd">    tests all use the same base dependencies from other modules.</span>

<span class="sd">    :attr identifier: a unique id for the test; the unit test executable will</span>
<span class="sd">      be created with this name.</span>
<span class="sd">    :attr description: included in the summary of the auto-generated program</span>
<span class="sd">      *.f90 file.</span>
<span class="sd">    :attr cases: a list of cases to run that use the same test specification</span>
<span class="sd">      except for a slight change in the names of input/model files.</span>
<span class="sd">    :attr runtime: an integer list [min, max] range for the time this test </span>
<span class="sd">      should take to run.</span>
<span class="sd">    :attr unit: either &#39;m&#39; or &#39;h&#39;; the units for &#39;runtime&#39;.</span>
<span class="sd">    :attr timed: when true, the execution time of the main method being unit tested</span>
<span class="sd">      will be accumulated and saved.</span>
<span class="sd">    :attr targets: a list of TestTarget instances that specify which variables</span>
<span class="sd">      and files need to be verified after the unit test runs.</span>
<span class="sd">    :attr inputs: a list of TestInput instances that specify how to initialize</span>
<span class="sd">      the values of the variables or that are required by other methods being</span>
<span class="sd">      run as pre-reqs of the main unit testing method.</span>
<span class="sd">    :attr output: a dict of TestOutput instances; keys are the output identifiers</span>
<span class="sd">      the values are the object instances. Represent sources for model data to</span>
<span class="sd">      compare the unit tests&#39; generated output to.</span>
<span class="sd">    :attr testgroup: the testing group that the specification belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmltag</span><span class="p">,</span> <span class="n">testgroup</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the test specification using the &lt;test&gt; tag that is</span>
<span class="sd">        a child of the &lt;outcome&gt; tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xmltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runchecks</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;A set of *local* assignments and pre-reqs that apply to this test.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;A set of *local* variable declarations for this test.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variable_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoclasses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;A dict of AutoClasser() instances for generating read/write blocks</span>
<span class="sd">        for user-derived type variables that are complex. We only need to write</span>
<span class="sd">        the variable declarations once per test specification, which is why we</span>
<span class="sd">        put them here.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span> <span class="o">=</span> <span class="n">testgroup</span>

        <span class="c1">#The name of the variable that holds the number of times to repeat</span>
        <span class="c1">#the execution of the method being tested.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#If any of the inputs runs in constant mode, this variable with be True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#The identifier is necessary to proceed; all the other xml attributes</span>
        <span class="c1">#and tags are parsed once the parent TestingGroup instance has parsed</span>
        <span class="c1">#*all* of its children.</span>
        <span class="k">if</span> <span class="s2">&quot;identifier&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Let&#39;s auto-assign an identifier.</span>
            <span class="n">root</span> <span class="o">=</span> <span class="s2">&quot;std&quot;</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">testgroup</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;identifier&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
                    <span class="n">root</span> <span class="o">+=</span> <span class="s2">&quot;I&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">root</span>

    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the instance of Executable code element that this specification</span>
<span class="sd">        will test.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">element</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">testable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this test specification includes at least one output</span>
<span class="sd">        specification making it testable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">autoclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if any of the assignments in the test specification require</span>
<span class="sd">        auto-class support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reads</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">autoclass</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">)])</span>
        <span class="n">writes</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">autoclass</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">reads</span> <span class="ow">or</span> <span class="n">writes</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">constant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a value indicating whether any of the inputs in this test</span>
<span class="sd">        run in constant-input mode.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constant</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of a variable to use for the do loop when the</span>
<span class="sd">        method execution is repeated for each line in constant-input file.&quot;&quot;&quot;</span>
        <span class="c1">#Find the first input specification that has operates in constant mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">repeats</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeats</span>

<div class="viewcode-block" id="TestSpecification.clean"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testroot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes all variable target output files so that the test folder</span>
<span class="sd">        is clean for a new run.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">testroot</span><span class="p">)</span>

        <span class="c1">#We also need to remove the timing of any previous tests that ran.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">:</span>
            <span class="n">timepath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testroot</span><span class="p">,</span> <span class="s2">&quot;fpytiming.out&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">timepath</span><span class="p">):</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">timepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSpecification.code_validate"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.code_validate">[docs]</a>    <span class="k">def</span> <span class="nf">code_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the fortran code to validate the length of the constant-valued</span>
<span class="sd">        input files if there is more than one of them.</span>

<span class="sd">        :arg lines: the list of strings that will form the contents of the</span>
<span class="sd">          *.f90 file being created for the executable.</span>
<span class="sd">        :arg variables: the dictionary of all global variables declared in</span>
<span class="sd">          the program to be used by any methods being run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Basically, we just want to generate a bunch of if statements and check</span>
        <span class="c1">#that the number of entries in each constant-valued input file is the same.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code_validate_single</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">spacer</span><span class="p">))</span></div>
        
    <span class="k">def</span> <span class="nf">_code_validate_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates an if/stop code block for checking the number of entries in</span>
<span class="sd">        constant-valued input files.</span>
<span class="sd">        </span>
<span class="sd">        :arg first: an instance of TestInput to compare with &#39;second&#39;.</span>
<span class="sd">        :arg second: an instance of TestInput to compare with &#39;first&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}if ({} .ne. {}) then&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">first</span><span class="o">.</span><span class="n">repeats</span><span class="p">,</span> <span class="n">second</span><span class="o">.</span><span class="n">repeats</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}stop(&#39;{} and {} must have same number of&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">first</span><span class="o">.</span><span class="n">iid</span><span class="p">,</span> <span class="n">second</span><span class="o">.</span><span class="n">iid</span><span class="p">)</span> <span class="o">+</span> 
                      <span class="s2">&quot; entries in their input files&#39;)&quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}end if&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="TestSpecification.code_vars"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.code_vars">[docs]</a>    <span class="k">def</span> <span class="nf">code_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends all the code required by all the input file specifications</span>
<span class="sd">        in order to run the unit test to the list.</span>

<span class="sd">        :arg lines: the list of strings that will form the contents of the</span>
<span class="sd">          *.f90 file being created for the executable.</span>
<span class="sd">        :arg variables: the dictionary of all global variables declared in</span>
<span class="sd">          the program to be used by any methods being run.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">code_vars</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>
            
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

        <span class="c1">#We need access to the test case locally for reading value with auto-class.</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}character(10) :: fpy_case&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="TestSpecification.code_init"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.code_init">[docs]</a>    <span class="k">def</span> <span class="nf">code_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends all code required to initialize all the constant-mode input</span>
<span class="sd">        file specifications and save starting values of targets.</span>

<span class="sd">        :arg lines: the list of strings that will form the contents of the</span>
<span class="sd">          *.f90 file being created for the executable.</span>
<span class="sd">        :arg variables: the dictionary of all global variables declared in</span>
<span class="sd">          the program to be used by any methods being run.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">code_init</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="s2">&quot;begin&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">autoclass</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call fpy_read(&#39;fpy_case&#39;, &#39;#&#39;, fpy_case)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="TestSpecification.code_before"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.code_before">[docs]</a>    <span class="k">def</span> <span class="nf">code_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends all code required to read the next values from a file into</span>
<span class="sd">        their variables *before* the main test function is called again.</span>

<span class="sd">        :arg lines: the list of strings that will form the contents of the</span>
<span class="sd">          *.f90 file being created for the executable.</span>
<span class="sd">        :arg variables: the dictionary of all global variables declared in</span>
<span class="sd">          the program to be used by any methods being run.&quot;&quot;&quot;</span>
        <span class="c1">#Before the unit test method executes, we want to get the next lot</span>
        <span class="c1">#of constant variable values read from the next lines in their</span>
        <span class="c1">#respective files.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">code_read</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSpecification.code_after"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.code_after">[docs]</a>    <span class="k">def</span> <span class="nf">code_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code required to save the value of any targets for this</span>
<span class="sd">        test to their files when their save frequency is set to &#39;each&#39;.</span>

<span class="sd">        :arg lines: the list of strings that will form the contents of the</span>
<span class="sd">          *.f90 file being created for the executable.</span>
<span class="sd">        :arg variables: the dictionary of all global variables declared in</span>
<span class="sd">          the program to be used by any methods being run.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="s2">&quot;each&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSpecification.code_finalize"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.code_finalize">[docs]</a>    <span class="k">def</span> <span class="nf">code_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code for cleaning up open file handles and saving the</span>
<span class="sd">        final values of the targets to their files.</span>

<span class="sd">        :arg lines: the list of strings that will form the contents of the</span>
<span class="sd">          *.f90 file being created for the executable.</span>
<span class="sd">        :arg variables: the dictionary of all global variables declared in</span>
<span class="sd">          the program to be used by any methods being run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">code_finalize</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSpecification.parse"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestSpecification.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the child-tags and attributes of this test specification once</span>
<span class="sd">        its parent testing group is finished parsing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">group_list</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">docopy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Appends all the elements in the collection that match the position</span>
<span class="sd">            specification to the given target.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">docopy</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
                    <span class="n">citem</span> <span class="o">=</span> <span class="n">item</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">docopy</span> <span class="k">else</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">citem</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">group_dict</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tordering</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">docopy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Updates the &#39;target&#39; dictionary to include all items in the &#39;collection&#39;</span>
<span class="sd">            that match the specified position.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">docopy</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
            <span class="k">if</span> <span class="n">ordering</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">ordering</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">collection</span>
                
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">collection</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
                    <span class="n">citem</span> <span class="o">=</span> <span class="n">item</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">docopy</span> <span class="k">else</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tordering</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>                        
                        <span class="n">tordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">citem</span><span class="p">)</span>
                    <span class="n">target</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection</span><span class="p">[</span><span class="n">citem</span><span class="p">]</span>
            
        <span class="c1">#We need to add all the pre-reqs and assignments from the parent group to</span>
        <span class="c1">#this one since they were specified globally for *all* tests.</span>
        <span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">methods</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
        <span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">docopy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
        <span class="n">group_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">group_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">variable_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_order</span><span class="p">)</span>
                        
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_attributes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_children</span><span class="p">()</span>

        <span class="c1">#Now handle the methods from the group that should be added *after* the local</span>
        <span class="c1">#assignments and pre-reqs are done.</span>
        <span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">methods</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
        <span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">docopy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
        <span class="n">group_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">group_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">testgroup</span><span class="o">.</span><span class="n">variable_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_order</span><span class="p">)</span>

        <span class="c1">#If there is only a single target and a single output, then match them up</span>
        <span class="c1">#even if there is no &quot;compareto&quot; and &quot;identifier&quot; on the &lt;target&gt; and &lt;output&gt;</span>
        <span class="c1">#tags.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compareto</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compareto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#Because of the testsource feature, the &lt;input&gt; tags have a reference to the</span>
        <span class="c1">#TestSpecification. We copied any from the TestingGroup above, but the Group</span>
        <span class="c1">#doesn&#39;t initialize the testspec (since it isn&#39;t one). We do that here.</span>
        <span class="k">for</span> <span class="n">xinput</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xinput</span><span class="o">.</span><span class="n">testspec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">xinput</span><span class="o">.</span><span class="n">testspec</span> <span class="o">=</span> <span class="bp">self</span></div>
                
    <span class="k">def</span> <span class="nf">_parse_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets all child tags from the &lt;test&gt; and parses them for relevant</span>
<span class="sd">        content to set targets, inputs and output attributes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestInput</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="n">outvar</span> <span class="o">=</span> <span class="n">TestOutput</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">outvar</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">outvar</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestTarget</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;prereq&quot;</span> <span class="ow">and</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestPreReq</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;assignment&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Assignment</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
                <span class="n">TestingGroup</span><span class="o">.</span><span class="n">global_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_order</span><span class="p">,</span>
                                        <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">child</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">_parse_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets test-level attributes from the xml tag if they exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;runchecks&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runchecks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;runchecks&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;execute&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;execute&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">:</span>
                <span class="c1">#If we don&#39;t run the executable, we obviously can&#39;t check outputs!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runchecks</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s2">&quot;cases&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="n">_expand_cases</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;cases&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;runtime&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runtime</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;timed&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;timed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="TestPreReq"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestPreReq">[docs]</a><span class="k">class</span> <span class="nc">TestPreReq</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a subroutine or function that must run before the main</span>
<span class="sd">    executable being unit-tested can run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="sd">&quot;&quot;&quot;The testing group or test specification instance that owns this tag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The &#39;module.executable&#39; identifier for the pre-req method to run.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>
        <span class="sd">&quot;&quot;&quot;For pre-reqs specified in a testing group, the user must decide whether</span>
<span class="sd">        the global methods run before/after the local test specification methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramlist</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Overrides the default behavior of the parameter list.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chainto</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Specifies the ID of the test specification that should be used when</span>
<span class="sd">        chaining the pre-reqs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;method&#39; is a required attribute of &lt;prereq&gt; tags.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;chainto&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chainto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;chainto&quot;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paramlist&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;paramlist&quot;</span><span class="p">]</span>    </div>
            
<div class="viewcode-block" id="TestingGroup"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestingGroup">[docs]</a><span class="k">class</span> <span class="nc">TestingGroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a unit testing documentation group with information on</span>
<span class="sd">    how to automate a unit test for a specific executable.</span>

<span class="sd">    :attr tests: a dict of TestSpecifications for running multiple tests</span>
<span class="sd">      that use the same variables, mappings and other parameters.</span>
<span class="sd">    :attr mappings: a dict with keys as the parameter names from the method</span>
<span class="sd">      being tested and values being the variable names to pass in.</span>
<span class="sd">    :attr assignments: a dict of assignments for changing the values of the</span>
<span class="sd">      variables.</span>
<span class="sd">    :attr children: a list of the DocElement instances who belong to this</span>
<span class="sd">      testing group.</span>
<span class="sd">    :attr methods: a dict of variable assignments and prereq methods for changing </span>
<span class="sd">      variable values or executing pre-req subroutines. </span>
<span class="sd">      The actual assignments are made as part of the executable chaining</span>
<span class="sd">      to make sure that values get changed in the correct order. </span>
<span class="sd">    :attr finder: the MethodFinder instance that this group belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the specified DocGroup to extract the unit testing info.</span>
<span class="sd">        </span>
<span class="sd">        :arg group: an instance of a DocGroup with purpose=&quot;testing&quot;.</span>
<span class="sd">        :arg element: the *code* element that the doc group belongs to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;A dict of test-group level variable names that have their values</span>
<span class="sd">        changed by a test-group level assignment. Keys are lowered variable names</span>
<span class="sd">        values are dicts of variable attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;A list of input files that need to be copied to the test execution directories</span>
<span class="sd">        for *all* the test specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dict of comparison outputs that should be available for *all* test specifications</span>
<span class="sd">        in the unit test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of the variables that should have their values saved to file and compared</span>
<span class="sd">        with model output for *all* the test specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staging</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The path of the staging directory relative to the code directory.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">finder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The currently active MethodFinder instance being used by the MethodWriter</span>
<span class="sd">        to create the executable driver for a specific testid.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;The order in which the global declarations appear in the group.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coderoot</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The absolute path to the code folder where the module file resides</span>
<span class="sd">        for the unit test being run.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_children</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_codes</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">method_fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the full module.method name of the executable that this</span>
<span class="sd">        group decorates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;{}.{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of the underlying DocGroup.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;unittests&quot;</span>
    
<div class="viewcode-block" id="TestingGroup.set_finder"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestingGroup.set_finder">[docs]</a>    <span class="k">def</span> <span class="nf">set_finder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the currently active MethodFinder instance being used by the MethodWriter</span>
<span class="sd">        to create the executable driver for a specific testid.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finder</span> <span class="o">=</span> <span class="n">finder</span></div>
    
    <span class="k">def</span> <span class="nf">_init_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a dictionary of function pointers for appending relevant</span>
<span class="sd">        code to the final executable for each test in the outcome.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">code_vars</span><span class="p">,</span>
                <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">code_init</span><span class="p">,</span>
                <span class="s2">&quot;validate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">code_validate</span><span class="p">,</span>
                <span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">code_before</span><span class="p">,</span>
                <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">code_after</span><span class="p">,</span>
                <span class="s2">&quot;final&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">code_finalize</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapper</span>

<div class="viewcode-block" id="TestingGroup.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestingGroup.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testid</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the relevant code for the specified test and section of</span>
<span class="sd">        the final executable file.</span>

<span class="sd">        :arg testid: the identifier of the test to append code for.</span>
<span class="sd">        :arg section: one of [&#39;vars&#39;, &#39;init&#39;, &#39;validate&#39;, &#39;before&#39;, &#39;after&#39;,</span>
<span class="sd">          &#39;final&#39;]. Refers to section of the PROGRAM *.f90 file being created.</span>
<span class="sd">        :arg lines: a list of the strings collected so far for the contents</span>
<span class="sd">          of the *.f90 program file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">testid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span> <span class="ow">and</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">testid</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_codes</span><span class="p">[</span><span class="n">testid</span><span class="p">][</span><span class="n">section</span><span class="p">](</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_find_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds all the DocElement instances in the parent code element </span>
<span class="sd">        that belong to this testing group.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">docel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">docstring</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">docel</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">docel</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">docel</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">docel</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">DocGroup</span><span class="p">)</span> <span class="ow">and</span> <span class="n">docel</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">docel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the XML structure into the relevant dictionaries and</span>
<span class="sd">        properties for the testing group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Try to determine the staging directory from the group definition.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s2">&quot;staging&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;staging&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">TestSpecification</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;prereq&quot;</span> <span class="ow">and</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestPreReq</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;assignment&quot;</span><span class="p">:</span>
                <span class="c1">#This is a variable assignment. Sometimes variable values are changed</span>
                <span class="c1">#between calls to functions. The order in which prereq/instance elements</span>
                <span class="c1">#appear defines when these assignments take place. We will treat a var</span>
                <span class="c1">#value assignment as a method to simplify the implementation.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Assignment</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                <span class="c1">#If the variable gets its value changed multiple times, the first time</span>
                <span class="c1">#should have allocation if applicable, otherwise it wouldn&#39;t work.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestInput</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="n">outvar</span> <span class="o">=</span> <span class="n">TestOutput</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">xml</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">outvar</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">outvar</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestTarget</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_childvar</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_mappings</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Subroutine&quot;</span><span class="p">,</span> <span class="s2">&quot;Function&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_globals</span><span class="p">()</span>

        <span class="c1">#Now that the testing group has all its children parsed, we can</span>
        <span class="c1">#let the tests parse. This is because some of the global tags in the</span>
        <span class="c1">#testing group will apply to every test.</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_childvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a &lt;global&gt; tag to the variables dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
            <span class="c1">#Handle the special case of an override definition for the functions</span>
            <span class="c1">#output variable that holds its return value.</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;[default]&quot;</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_fpy&quot;</span>
            <span class="n">TestingGroup</span><span class="o">.</span><span class="n">global_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="p">,</span>
                                    <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_param_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts global declarations from the parameter regular=&quot;true&quot; attribute</span>
<span class="sd">        of paramater decorations.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="c1">#If the executable we are handling parameters for is an embedded procedure</span>
            <span class="c1">#in a custom type, then we want to initialize the variable instance for</span>
            <span class="c1">#the type, even if there is no reglar=&quot;true&quot;; developers will seldom put</span>
            <span class="c1">#a &lt;parameter&gt; tag on the first argument to an embedded procedure because</span>
            <span class="c1">#it is always the class instance.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">is_type_target</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">is_type_target</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1">#is_type_target is the instance of the CustomType that owns it.</span>
                <span class="n">glob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_from_param</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">glob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">TestingGroup</span><span class="o">.</span><span class="n">global_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">glob</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Check the docstrings for a regular=&quot;true&quot; attribute.</span>
                <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">docstring</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;parameter&quot;</span> <span class="ow">and</span> \
                       <span class="s2">&quot;regular&quot;</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="n">doc</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                        <span class="n">glob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_from_param</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">glob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">TestingGroup</span><span class="o">.</span><span class="n">global_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_order</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">glob</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_global_from_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a global DocElement from the specified executable&#39;s parameter &quot;name&quot;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DocElement</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">doctype</span> <span class="o">=</span> <span class="s2">&quot;AUTOPARAM&quot;</span>
            <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span>
            <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">D</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_clean_param</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_clean_param</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;modifiers&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">modifiers</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_clean_param</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_clean_param</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            
            <span class="c1">#if the variable is a deferred shape array and we have been told to allocate</span>
            <span class="c1">#it during the initializing phase then we must add &quot;allocatable&quot; as a modifier</span>
            <span class="c1">#if it isn&#39;t already allocatable or a pointer.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
                <span class="n">allocate</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;allocate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">and</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;allocate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;modifiers&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="ow">not</span>
                    <span class="p">(</span><span class="s2">&quot;allocatable&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">modifiers</span> <span class="ow">or</span>
                     <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">modifiers</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;, allocatable&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;modifiers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;allocatable&quot;</span>
                    
            <span class="c1">#For regular=&quot;true&quot; parameters of the class variable this/self, we need to</span>
            <span class="c1">#explicitly add the pointer modifier so that the allocation works.</span>
            <span class="n">needsadj</span> <span class="o">=</span> <span class="p">((</span><span class="n">param</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;class&quot;</span> <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="s2">&quot;pointer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span> <span class="ow">and</span>
                         <span class="s2">&quot;allocatable&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">needsadj</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pointer&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;, pointer&quot;</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_global_clean_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the specified parameter name and value to the result if the value is not None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TestingGroup.global_add"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.TestingGroup.global_add">[docs]</a>    <span class="k">def</span> <span class="nf">global_add</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a global declaration for the specified DocElement if it isn&#39;t already</span>
<span class="sd">        represented in the list.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">GlobalDeclaration</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;doctype&quot;</span><span class="p">)</span> <span class="ow">and</span>
              <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;AUTOPARAM&quot;</span><span class="p">):</span>
            <span class="c1">#We can override the existing variable declaration because it was from a</span>
            <span class="c1">#parent test group and a global tag takes precedence. AUTOPARAMS are only</span>
            <span class="c1">#generated from regular=&quot;true&quot; tags, so the [default] &lt;globals&gt; would never</span>
            <span class="c1">#be handled in this section.</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">GlobalDeclaration</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We need to make sure that it is unique compared to the existing</span>
            <span class="c1">#one. If it isn&#39;t, stop the execution. If it is, we don&#39;t need</span>
            <span class="c1">#to add it again.</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="o">.</span><span class="n">ignore</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">existing</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="s2">&quot;variables in the calling namespace have the same name,&quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot; but different types: </span><span class="se">\n</span><span class="s2">{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">doc</span><span class="p">))</span>
                <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Searches the group for &lt;mapping&gt; tags and adds them to the </span>
<span class="sd">        mapping dict.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">doctype</span> <span class="o">==</span> <span class="s2">&quot;mapping&quot;</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span>
                <span class="ow">and</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span></div>
        
<div class="viewcode-block" id="MethodFinder"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.MethodFinder">[docs]</a><span class="k">class</span> <span class="nc">MethodFinder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for recursively finding methods for executing pre-req methods</span>
<span class="sd">    that takes recursive dependencies into account.</span>

<span class="sd">    :arg identifier: the &quot;module.executable&quot; that this method finder represents</span>
<span class="sd">    :arg parser: the code parser instance for inter-module access.</span>
<span class="sd">    :arg element: the DocElement that specified this method as a pre-req.</span>
<span class="sd">    :arg testid: the identifier of the test specification that this method finder is</span>
<span class="sd">      being constructed for.</span>
<span class="sd">    :arg fatal_if_missing: specified whether the framework chokes if it can&#39;t</span>
<span class="sd">      find a method that is referenced as a pre-req.</span>
<span class="sd">    :attr executable: the code element instance of the executable found from</span>
<span class="sd">      the module that the method belongs to.</span>
<span class="sd">    :attr main: when true, this instance is for the *main* method being unit tested.</span>
<span class="sd">    :attr basic: when true, the Finder only initializes the executable attribute for</span>
<span class="sd">      the given identifier, but doesn&#39;t recursively find pre-req and other dependency</span>
<span class="sd">      methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">testid</span><span class="p">,</span> <span class="n">fatal_if_missing</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="n">main</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">basic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writekey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="sd">&quot;&quot;&quot;Key to uniquely identify this method finder from any other that exists because</span>
<span class="sd">        of multiple calls to the same pre-requisite methods.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="o">=</span> <span class="n">testid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;The TestSpecification instance for the unit test that this method finder is</span>
<span class="sd">        operating under.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fatal</span> <span class="o">=</span> <span class="n">fatal_if_missing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_executable</span><span class="p">()</span>
        <span class="c1">#If we have a result, get a pointer to the tests so we don&#39;t have to go one level</span>
        <span class="c1">#deep all the time.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">test_group</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="s2">&quot;repeats&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;repeats&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="k">elif</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#The main method is always repeatable; it is only the pre-reqs that can</span>
            <span class="c1">#be selected as repeatable or not.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeats</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">basic</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;terminate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;terminate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
            <span class="c1">#&#39;basic&#39; is important so that we can efficiently find the executables with this</span>
            <span class="c1">#class but not have the overhead of the recursive find. If they manually specified</span>
            <span class="c1">#a termination, we should honor that now as well.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Executable {} has no testing group; aborting pre-req search&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1">#Get the reference to the specific test that this finder is running for.</span>
        <span class="k">if</span> <span class="n">testid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">testid</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unit test {} cannot be found in docstrings.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testid</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#By default, if there isn&#39;t a testid specified, we can just use the</span>
            <span class="c1">#first test in the testing group.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">tests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">testid</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot auto-detect test identifier for {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>

        <span class="c1">#Recursively get all the pre-requisite for this method. However if the &quot;terminate&quot;</span>
        <span class="c1">#attribute is in the doc element, then don&#39;t. The main method being unit tested</span>
        <span class="c1">#is at the top of the recursive tree of MethodFinders and it is initialized with</span>
        <span class="c1">#element==None; all the lower branches in the recursion tree are initialized with</span>
        <span class="c1">#their respective doc element instances.</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> \
           <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;terminate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> 
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;terminate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_prereqs</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specifies whether any pre-reqs chained to this method should be executed or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;terminate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;terminate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>        
            
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the CodeParser instance for inter-modular access.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span>
            
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all the global variables declared by the testing</span>
<span class="sd">        group of this method if they exist.&quot;&quot;&quot;</span>
        <span class="c1">#We give preference to test specification variable lists.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">variables</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">variables</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the dictionary of attributes from the underlying xml tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">DocElement</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">attributes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>                  

<div class="viewcode-block" id="MethodFinder.add_prereq"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.MethodFinder.add_prereq">[docs]</a>    <span class="k">def</span> <span class="nf">add_prereq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identify</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">chainto</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a MethodFinder instance to the current one for the specified </span>
<span class="sd">        &#39;module.executable&#39; identity.</span>

<span class="sd">        :arg identify: a string of &quot;modulename.executablename&quot;.</span>
<span class="sd">        :arg tag: the DocElement instance that resulted in this prereq being added.</span>
<span class="sd">        :arg chainto: the test identifier specified by the pre-req that should be used</span>
<span class="sd">          for chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#The only reason this method exists is to prevent an import loop problem</span>
        <span class="c1">#It gets used by the AssignmentValue._code_embedded().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MethodFinder</span><span class="p">(</span><span class="n">identify</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">chainto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatal</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_get_prereqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles a list of subroutines that need to run. Handles recursive calls.&quot;&quot;&quot;</span>
        <span class="c1">#Make sure we have tests to run off of; some of the routines that are dependencies</span>
        <span class="c1">#won&#39;t necessarily have any docstrings.</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">TestPreReq</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MethodFinder</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span>
                                                 <span class="n">method</span><span class="o">.</span><span class="n">chainto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatal</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">):</span>
                <span class="c1">#This is a variable assignment. Sometimes variable values are changed</span>
                <span class="c1">#between calls to functions. The order in which prereq/instance elements</span>
                <span class="c1">#appear defines when these assignments take place. We will treat a var</span>
                <span class="c1">#value assignment as a method to simplify the implementation.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="c1">#Now that we have the method tree setup; we need to check each of the Assignments</span>
        <span class="c1">#to get their pre-reqs straightened out.</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">check_prereqs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
<div class="viewcode-block" id="MethodFinder.timed"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.MethodFinder.timed">[docs]</a>    <span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if this method will produce code to time its execution.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">:</span>
            <span class="n">testspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">testid</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">testspec</span><span class="o">.</span><span class="n">timed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>        </div>

<div class="viewcode-block" id="MethodFinder.code"><a class="viewcode-back" href="../../../testing.html#fortpy.testing.elements.MethodFinder.code">[docs]</a>    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">testid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code to execute *only* this method&#39;s main executable as</span>
<span class="sd">        part of the main program.</span>

<span class="sd">        :arg lines: the list of strings that form the contents of the *.f90 file</span>
<span class="sd">          being created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#We only need to worry about vars if this is the *main* method that is</span>
        <span class="c1">#being unit tested.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="ow">and</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code_vars</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">testid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code_call</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">testid</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="n">testid</span><span class="p">)</span> <span class="ow">and</span> <span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call pysave(fpy_elapsed, &#39;fpytiming.out&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_code_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">testid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends code to initialize the variables that accept the return values</span>
<span class="sd">        if the method being called is a function. Also appends the variables needed</span>
<span class="sd">        to time the method&#39;s execution if specified by the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#This method only gets called if we are the main executable being tested.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_fpy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">definition</span><span class="p">(</span><span class="s2">&quot;_fpy&quot;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="n">testid</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}real(fdp) :: fpy_start, fpy_end, fpy_elapsed = 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_code_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spacer</span><span class="p">,</span> <span class="n">testid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the code to call the executable that this method finder represents.&quot;&quot;&quot;</span>
        <span class="c1">#If we are timing the executable, we want to get the time before and after the</span>
        <span class="c1">#execution of just this method and then add it to the elapsed time.</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="n">testid</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call cpu_time(fpy_start)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>

        <span class="c1">#This is either a call to a subroutine or a function. We need to make</span>
        <span class="c1">#sure that we handle any mapping tags or call tags in the docstrings</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;Subroutine&quot;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;call &quot;</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#For a function, we still need to save the value somewhere so we</span>
            <span class="c1">#can compare it.</span>
            <span class="n">pntr</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="s2">&quot;pointer&quot;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">modifiers</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;{}_fpy ={} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pntr</span><span class="p">)</span>

        <span class="n">spacing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">spacer</span><span class="p">)</span>

        <span class="c1">#Unfortunately, the fpy_auxiliary module freaks out if we call a public</span>
        <span class="c1">#method directly which is *also* a module procedure for the type (since</span>
        <span class="c1">#the .mod files vary because of the extra public subroutine on the type,</span>
        <span class="c1">#the compiler dies with Abort trap 6 error. So, we need to call embedded</span>
        <span class="c1">#methods using the %-syntax.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">is_type_target</span><span class="p">:</span>
            <span class="n">callname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span>
            <span class="n">xtype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">is_type_target</span>
            <span class="k">for</span> <span class="n">emname</span><span class="p">,</span> <span class="n">emexec</span> <span class="ow">in</span> <span class="n">xtype</span><span class="o">.</span><span class="n">executables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">emexec</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">:</span>
                    <span class="n">callname</span> <span class="o">=</span> <span class="n">emname</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">callname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span>
        
        <span class="k">if</span> <span class="s2">&quot;paramlist&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="c1">#The developer has decided on an alternate call signature from</span>
            <span class="c1">#the one that gets auto-generated.</span>
            <span class="n">specified</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,\s*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;paramlist&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">xtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">specified</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">ordered_parameters</span><span class="p">):</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Explicit parameter list for embedded executable should *exclude* the &quot;</span>
                         <span class="s2">&quot;reference to &#39;self&#39; in the first argument.&quot;</span><span class="p">)</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="n">present_params</span><span class="p">(</span><span class="n">specified</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">callname</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#We can construct the actual list of parameters to use in the call</span>
            <span class="c1">#and substitute mappings where appropriate.</span>
            <span class="n">calllist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">ordered_parameters</span><span class="p">):</span>
                <span class="c1">#Because of ignorable parameters, if the parameter is optional, explicitly</span>
                <span class="c1">#specify its name.</span>
                <span class="k">if</span> <span class="s2">&quot;optional&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
                    <span class="n">optstr</span> <span class="o">=</span> <span class="s2">&quot;{}=&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">optstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">mappings</span><span class="p">:</span>
                    <span class="c1">#The first parameter name will also be the name of the variable that gets</span>
                    <span class="c1">#created and called.</span>
                    <span class="k">if</span> <span class="n">xtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">callname</span> <span class="o">=</span> <span class="s2">&quot;{}%{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">param</span><span class="p">],</span> <span class="n">callname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">calllist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optstr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1">#The test specification takes precedence over the testing group for variables.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">xtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">callname</span> <span class="o">=</span> <span class="s2">&quot;{}%{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">callname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                            <span class="n">calllist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optstr</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">var</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">calllist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optstr</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}{}{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">callname</span><span class="p">,</span>
                                              <span class="n">present_params</span><span class="p">(</span><span class="n">calllist</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="mi">90</span><span class="p">)))</span>        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="n">testid</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}call cpu_time(fpy_end)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{}fpy_elapsed = fpy_elapsed + fpy_end - fpy_start&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spacer</span><span class="p">))</span>
                
    <span class="k">def</span> <span class="nf">_find_executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the executable code element from the code parser instance.&quot;&quot;&quot;</span>
        <span class="c1">#First, we need to determine which module the identifier points to.</span>
        <span class="c1">#See if the module is in the code parser</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#We want to use the code parsers tree search to get the executable</span>
            <span class="c1">#If the identifier refers to a type method, we need to use the</span>
            <span class="c1">#type search</span>
            <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">tbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">type_search</span><span class="p">(</span><span class="n">tbase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Executable</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">element</span>                   
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#This is just a standard exectable inside the module</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatal</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FATAL: a specified executable was not found in&quot;</span> <span class="o">+</span> 
                                     <span class="s2">&quot;the module: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the module instance for this method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="c1">#Try a dependency search for the specific module</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">load_dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="c1">#If the module was found, we can set the value of the local variable</span>
                <span class="c1">#otherwise we will end the program by default</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatal</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FATAL: the module for a pre-requisite method could &quot;</span> <span class="o">+</span> 
                                     <span class="s2">&quot;not be located: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>        </div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Conrad W. Rosenbrock.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>